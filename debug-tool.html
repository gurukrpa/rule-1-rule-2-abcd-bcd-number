<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABCD/BCD Data Pipeline Debug</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success { color: #00ff00; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
        .info { color: #44aaff; }
        .code-block {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0088ff;
        }
        .result {
            min-height: 100px;
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç ABCD/BCD Data Pipeline Debug Tool</h1>
        
        <div class="section">
            <h2>üéØ Quick Data Check</h2>
            <button onclick="runDataCheck()">Check Data Status</button>
            <div id="dataCheckResult" class="result"></div>
        </div>

        <div class="section">
            <h2>üë§ User & Storage Info</h2>
            <button onclick="checkUserData()">Check User Data</button>
            <div id="userDataResult" class="result"></div>
        </div>

        <div class="section">
            <h2>üìä Excel Data Analysis</h2>
            <button onclick="analyzeExcelData()">Analyze Excel Files</button>
            <div id="excelAnalysisResult" class="result"></div>
        </div>

        <div class="section">
            <h2>‚è∞ Hour Data Analysis</h2>
            <button onclick="analyzeHourData()">Analyze Hour Files</button>
            <div id="hourAnalysisResult" class="result"></div>
        </div>

        <div class="section">
            <h2>üß™ Create Test Data</h2>
            <button onclick="createTestData()">Create Sample ABCD/BCD Data</button>
            <div id="testDataResult" class="result"></div>
        </div>

        <div class="section">
            <h2>üîÑ Navigation</h2>
            <button onclick="goToApp()">Go Back to App</button>
            <button onclick="clearAllData()" style="background: #cc0000;">Clear All Data (Reset)</button>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const colors = {
                success: '#00ff00',
                error: '#ff4444', 
                warning: '#ffaa00',
                info: '#44aaff'
            };
            return `<span style="color: ${colors[type]}">${message}</span>`;
        }

        function runDataCheck() {
            const result = document.getElementById('dataCheckResult');
            result.innerHTML = '';
            
            try {
                result.innerHTML += log('üîç IMMEDIATE ABCD/BCD DATA PIPELINE DEBUG', 'info') + '\\n';
                result.innerHTML += log('==========================================', 'info') + '\\n\\n';

                // Check URL
                if (window.location.href.includes('localhost:5173')) {
                    result.innerHTML += log('‚úÖ On localhost development server', 'success') + '\\n';
                } else {
                    result.innerHTML += log('‚ùå Not on localhost - URL: ' + window.location.href, 'error') + '\\n';
                }

                // Check localStorage for basic data
                const userId = localStorage.getItem('userId');
                result.innerHTML += log('\\nüë§ User ID: ' + (userId || 'NOT FOUND'), userId ? 'success' : 'error') + '\\n';

                if (userId) {
                    const allKeys = Object.keys(localStorage);
                    const userKeys = allKeys.filter(key => key.includes(userId));
                    
                    result.innerHTML += log('\\nüìä User-related localStorage keys: ' + userKeys.length, 'info') + '\\n';
                    
                    // Check for Excel data
                    const excelKeys = userKeys.filter(key => key.includes('excel'));
                    result.innerHTML += log('üìã Excel data keys: ' + excelKeys.length + ' found', excelKeys.length > 0 ? 'success' : 'warning') + '\\n';
                    
                    // Check for hour data
                    const hourKeys = userKeys.filter(key => key.includes('hour'));
                    result.innerHTML += log('‚è∞ Hour data keys: ' + hourKeys.length + ' found', hourKeys.length > 0 ? 'success' : 'warning') + '\\n';
                    
                    if (excelKeys.length === 0) {
                        result.innerHTML += log('\\n‚ùå ISSUE FOUND: No Excel data in localStorage', 'error') + '\\n';
                        result.innerHTML += log('üí° SOLUTION: You need to upload Excel files first', 'warning') + '\\n';
                    } else if (hourKeys.length === 0) {
                        result.innerHTML += log('\\n‚ùå ISSUE FOUND: No Hour data in localStorage', 'error') + '\\n';
                        result.innerHTML += log('üí° SOLUTION: You need to save HR selections first', 'warning') + '\\n';
                    } else {
                        result.innerHTML += log('\\n‚úÖ Basic data exists - issue is in data extraction logic', 'success') + '\\n';
                    }
                } else {
                    result.innerHTML += log('\\n‚ùå CRITICAL ISSUE: No user ID found', 'error') + '\\n';
                    result.innerHTML += log('üí° SOLUTION: Go to main page and create/select a user first', 'warning') + '\\n';
                }

                result.innerHTML += log('\\nüéØ NEXT STEPS:', 'info') + '\\n';
                result.innerHTML += log('1. If no user ID: Go to main page and create user', 'info') + '\\n';
                result.innerHTML += log('2. If no Excel/Hour data: Upload files and save HR selections', 'info') + '\\n';
                result.innerHTML += log('3. If data exists: Check the other analysis buttons below', 'info') + '\\n';

            } catch (error) {
                result.innerHTML += log('‚ùå Error during check: ' + error.message, 'error') + '\\n';
            }
        }

        function checkUserData() {
            const result = document.getElementById('userDataResult');
            result.innerHTML = '';
            
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    result.innerHTML += log('‚ùå No user ID found', 'error') + '\\n';
                    return;
                }

                result.innerHTML += log('üë§ User ID: ' + userId, 'success') + '\\n';
                
                const allKeys = Object.keys(localStorage);
                const userKeys = allKeys.filter(key => key.includes(userId));
                
                result.innerHTML += log('\\nüìä All user-related keys:', 'info') + '\\n';
                userKeys.forEach(key => {
                    result.innerHTML += log('  - ' + key, 'info') + '\\n';
                });

                // Check for specific date patterns
                const datePattern = /\\d{4}-\\d{2}-\\d{2}/;
                const dateKeys = userKeys.filter(key => datePattern.test(key));
                result.innerHTML += log('\\nüìÖ Keys with date patterns: ' + dateKeys.length, 'info') + '\\n';
                dateKeys.forEach(key => {
                    const match = key.match(datePattern);
                    if (match) {
                        result.innerHTML += log('  - ' + match[0] + ' in: ' + key, 'info') + '\\n';
                    }
                });

            } catch (error) {
                result.innerHTML += log('‚ùå Error: ' + error.message, 'error') + '\\n';
            }
        }

        function analyzeExcelData() {
            const result = document.getElementById('excelAnalysisResult');
            result.innerHTML = '';
            
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    result.innerHTML += log('‚ùå No user ID found', 'error') + '\\n';
                    return;
                }

                const allKeys = Object.keys(localStorage);
                const excelKeys = allKeys.filter(key => key.includes(userId) && key.includes('excel'));
                
                result.innerHTML += log('üìã Excel Files Analysis', 'info') + '\\n';
                result.innerHTML += log('============================', 'info') + '\\n';
                result.innerHTML += log('Total Excel files: ' + excelKeys.length, 'info') + '\\n\\n';

                if (excelKeys.length === 0) {
                    result.innerHTML += log('‚ùå No Excel files found!', 'error') + '\\n';
                    result.innerHTML += log('üí° Go to main page and upload Excel files', 'warning') + '\\n';
                    return;
                }

                // Analyze first few Excel files
                const samplesToCheck = Math.min(3, excelKeys.length);
                for (let i = 0; i < samplesToCheck; i++) {
                    const key = excelKeys[i];
                    const data = JSON.parse(localStorage.getItem(key));
                    
                    result.innerHTML += log('üìä File ' + (i + 1) + ': ' + key, 'info') + '\\n';
                    result.innerHTML += log('- Has data property: ' + !!data.data, data.data ? 'success' : 'error') + '\\n';
                    result.innerHTML += log('- Has sets property: ' + !!data.data?.sets, data.data?.sets ? 'success' : 'error') + '\\n';
                    
                    if (data.data?.sets) {
                        const setNames = Object.keys(data.data.sets);
                        result.innerHTML += log('- Set count: ' + setNames.length, setNames.length > 0 ? 'success' : 'warning') + '\\n';
                        result.innerHTML += log('- Set names: ' + setNames.join(', '), 'info') + '\\n';
                        
                        // Check first set structure
                        if (setNames.length > 0) {
                            const firstSet = data.data.sets[setNames[0]];
                            const elements = Object.keys(firstSet);
                            result.innerHTML += log('- Elements in ' + setNames[0] + ': ' + elements.length, 'info') + '\\n';
                            
                            if (elements.length > 0) {
                                const firstElement = firstSet[elements[0]];
                                const planets = Object.keys(firstElement);
                                result.innerHTML += log('- Planets in ' + elements[0] + ': ' + planets.join(', '), 'info') + '\\n';
                                
                                // Show sample data
                                if (planets.length > 0) {
                                    const sampleValue = firstElement[planets[0]];
                                    result.innerHTML += log('- Sample value: "' + sampleValue + '"', 'info') + '\\n';
                                }
                            }
                        }
                    }
                    result.innerHTML += log('', 'info') + '\\n';
                }

            } catch (error) {
                result.innerHTML += log('‚ùå Error: ' + error.message, 'error') + '\\n';
            }
        }

        function analyzeHourData() {
            const result = document.getElementById('hourAnalysisResult');
            result.innerHTML = '';
            
            try {
                const userId = localStorage.getItem('userId');
                if (!userId) {
                    result.innerHTML += log('‚ùå No user ID found', 'error') + '\\n';
                    return;
                }

                const allKeys = Object.keys(localStorage);
                const hourKeys = allKeys.filter(key => key.includes(userId) && key.includes('hour'));
                
                result.innerHTML += log('‚è∞ Hour Files Analysis', 'info') + '\\n';
                result.innerHTML += log('=========================', 'info') + '\\n';
                result.innerHTML += log('Total Hour files: ' + hourKeys.length, 'info') + '\\n\\n';

                if (hourKeys.length === 0) {
                    result.innerHTML += log('‚ùå No Hour files found!', 'error') + '\\n';
                    result.innerHTML += log('üí° Go to main page and save HR selections', 'warning') + '\\n';
                    return;
                }

                // Analyze first few Hour files
                const samplesToCheck = Math.min(3, hourKeys.length);
                for (let i = 0; i < samplesToCheck; i++) {
                    const key = hourKeys[i];
                    const data = JSON.parse(localStorage.getItem(key));
                    
                    result.innerHTML += log('‚è∞ File ' + (i + 1) + ': ' + key, 'info') + '\\n';
                    result.innerHTML += log('- Has planetSelections: ' + !!data.planetSelections, data.planetSelections ? 'success' : 'error') + '\\n';
                    
                    if (data.planetSelections) {
                        const hrKeys = Object.keys(data.planetSelections);
                        result.innerHTML += log('- HR count: ' + hrKeys.length, hrKeys.length > 0 ? 'success' : 'warning') + '\\n';
                        result.innerHTML += log('- HR numbers: ' + hrKeys.join(', '), 'info') + '\\n';
                        
                        // Show planet selections
                        hrKeys.forEach(hr => {
                            const planet = data.planetSelections[hr];
                            result.innerHTML += log('  - HR ' + hr + ': ' + planet, 'info') + '\\n';
                        });
                    }
                    result.innerHTML += log('', 'info') + '\\n';
                }

            } catch (error) {
                result.innerHTML += log('‚ùå Error: ' + error.message, 'error') + '\\n';
            }
        }

        function createTestData() {
            const result = document.getElementById('testDataResult');
            result.innerHTML = '';
            
            try {
                result.innerHTML += log('üß™ Creating Test Data for ABCD/BCD Analysis', 'info') + '\\n';
                result.innerHTML += log('============================================', 'info') + '\\n';

                const userId = 'test-user-' + Date.now();
                localStorage.setItem('userId', userId);
                
                result.innerHTML += log('üë§ Created user ID: ' + userId, 'success') + '\\n';
                
                // Create test dates (4 consecutive days)
                const today = new Date();
                const dates = [];
                for (let i = 3; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                }
                
                const [aDay, bDay, cDay, dDay] = dates;
                result.innerHTML += log('üìÖ Test dates: ' + dates.join(', '), 'info') + '\\n';
                
                // Create sample data for each day
                const sampleNumbers = {
                    [aDay]: [1, 2, 15, 20, 25, 30],
                    [bDay]: [1, 3, 16, 21, 26, 31], 
                    [cDay]: [2, 4, 17, 22, 27, 32],
                    [dDay]: [1, 2, 3, 4, 5, 18]
                };

                dates.forEach(date => {
                    // Create Excel data
                    const excelData = {
                        data: {
                            sets: {
                                'D-1 Set-1 Matrix': {
                                    'element1': { 'Sun': 'as-' + sampleNumbers[date][0] + '/su-20', 'Moon': 'mo-' + sampleNumbers[date][1] + '/ve-25' },
                                    'element2': { 'Sun': 'li-' + sampleNumbers[date][2] + '/ma-30', 'Moon': 'ar-' + sampleNumbers[date][3] + '/ju-35' },
                                    'element3': { 'Sun': 'vi-' + sampleNumbers[date][4] + '/sa-40', 'Moon': 'le-' + sampleNumbers[date][5] + '/me-45' }
                                }
                            }
                        }
                    };

                    // Create hour data
                    const hourData = {
                        planetSelections: { '1': 'Sun', '2': 'Moon' }
                    };

                    localStorage.setItem(userId + '_excel_' + date, JSON.stringify(excelData));
                    localStorage.setItem(userId + '_hour_' + date, JSON.stringify(hourData));
                });

                result.innerHTML += log('‚úÖ Test data created successfully!', 'success') + '\\n\\n';
                
                // Show expected results
                result.innerHTML += log('üéØ Expected ABCD/BCD Results:', 'info') + '\\n';
                result.innerHTML += log('D-day numbers: [' + sampleNumbers[dDay].join(', ') + ']', 'info') + '\\n';
                result.innerHTML += log('Expected ABCD: [1, 2] (appear in ‚â•2 ABC days)', 'success') + '\\n';
                result.innerHTML += log('Expected BCD: [3, 4] (exclusive B-D or C-D pairs)', 'success') + '\\n';
                result.innerHTML += log('\\nüöÄ Now refresh the app and try Rule2CompactPage!', 'warning') + '\\n';

            } catch (error) {
                result.innerHTML += log('‚ùå Error: ' + error.message, 'error') + '\\n';
            }
        }

        function goToApp() {
            window.location.href = 'http://localhost:5173/';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL localStorage data? This cannot be undone!')) {
                localStorage.clear();
                alert('All data cleared! Go to main page to start fresh.');
            }
        }

        // Auto-run data check on page load
        window.onload = function() {
            runDataCheck();
        };
    </script>
</body>
</html>
