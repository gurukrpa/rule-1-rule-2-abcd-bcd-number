<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auto-Upload Bug Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid; }
        .success { background: #d4edda; border-color: #28a745; color: #155724; }
        .error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Auto-Upload Status Bug Test</h1>
        <p>This tool tests if the auto-upload status bug has been fixed after database cleanup.</p>
        
        <button onclick="runStatusTest()">üß™ Test Status Logic</button>
        <button onclick="clearBrowserCache()">üóëÔ∏è Clear Browser Cache</button>
        <button onclick="openMainApp()">üöÄ Open Main App</button>
        
        <div id="results"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://gwkkrfqdowbqszhtwjvh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3a2tyZnFkb3dicXN6aHR3anZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU3MzUwMzIsImV4cCI6MjA1MTMxMTAzMn0.3E_6E8-5i_SqCPAQ5AKbw9zO5p3G1y6zNXDWxCDY6QE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const resultsDiv = document.getElementById('results');

        async function runStatusTest() {
            resultsDiv.innerHTML = '<div class="test-result info">üîÑ Running status tests...</div>';
            
            try {
                const userId = 'sing maya';
                const futureDate = '2025-07-15'; // A date that definitely shouldn't exist
                
                let output = '<h3>üìä Status Test Results</h3>';
                
                // Test 1: Check if a future date correctly shows as not uploaded
                output += '<h4>Test 1: Future Date Status Check</h4>';
                output += `<p>Testing date: <strong>${futureDate}</strong></p>`;
                
                // Check Excel data
                const { count: excelCount, error: excelError } = await supabase
                    .from('excel_data')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userId)
                    .eq('date', futureDate);
                
                // Check Hour entry data  
                const { count: hourCount, error: hourError } = await supabase
                    .from('hour_entries')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userId)
                    .eq('date_key', futureDate);
                
                output += `<div class="test-result ${excelCount === 0 ? 'success' : 'error'}">`;
                output += `üìä Excel Status: ${excelCount === 0 ? 'üî¥ NOT UPLOADED (CORRECT)' : 'üü¢ UPLOADED (BUG!)'}`;
                output += `<br>Database count: ${excelCount}`;
                if (excelError) output += `<br>Error: ${excelError.message}`;
                output += `</div>`;
                
                output += `<div class="test-result ${hourCount === 0 ? 'success' : 'error'}">`;
                output += `‚è∞ Hour Entry Status: ${hourCount === 0 ? 'üî¥ NOT UPLOADED (CORRECT)' : 'üü¢ UPLOADED (BUG!)'}`;
                output += `<br>Database count: ${hourCount}`;
                if (hourError) output += `<br>Error: ${hourError.message}`;
                output += `</div>`;
                
                // Overall result
                const bugFixed = excelCount === 0 && hourCount === 0;
                output += `<div class="test-result ${bugFixed ? 'success' : 'error'}">`;
                output += `<h4>${bugFixed ? '‚úÖ SUCCESS: Bug appears to be FIXED!' : '‚ùå WARNING: Bug may still exist'}</h4>`;
                if (bugFixed) {
                    output += `<p>‚úÖ New dates correctly show as NOT uploaded (red status)</p>`;
                    output += `<p>‚úÖ Database cleanup successfully removed orphaned data</p>`;
                } else {
                    output += `<p>‚ùå New dates incorrectly show as uploaded (green status)</p>`;
                    output += `<p>‚ùå Additional cleanup or browser cache clearing may be needed</p>`;
                }
                output += `</div>`;
                
                // Test 2: Check localStorage for interfering data
                output += '<h4>Test 2: Browser Cache Check</h4>';
                const allKeys = Object.keys(localStorage);
                const problematicKeys = allKeys.filter(key => 
                    key.includes('abcd_') || 
                    key.includes('excel') || 
                    key.includes('hour') || 
                    key.includes('status') ||
                    key.includes(userId)
                );
                
                if (problematicKeys.length > 0) {
                    output += `<div class="test-result warning">`;
                    output += `‚ö†Ô∏è Found ${problematicKeys.length} potentially interfering cache keys:`;
                    output += `<pre>${problematicKeys.join('\\n')}</pre>`;
                    output += `<p>Consider clearing browser cache if issues persist.</p>`;
                    output += `</div>`;
                } else {
                    output += `<div class="test-result success">`;
                    output += `‚úÖ No interfering localStorage keys found`;
                    output += `</div>`;
                }
                
                // Test 3: Check existing data
                output += '<h4>Test 3: Existing Data Verification</h4>';
                const existingDate = '2025-07-03'; // Known existing date
                
                const { count: existingExcelCount } = await supabase
                    .from('excel_data')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userId)
                    .eq('date', existingDate);
                
                const { count: existingHourCount } = await supabase
                    .from('hour_entries')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', userId)
                    .eq('date_key', existingDate);
                
                output += `<div class="test-result info">`;
                output += `üìÖ Known existing date (${existingDate}):`;
                output += `<br>üìä Excel: ${existingExcelCount > 0 ? 'üü¢ EXISTS' : 'üî¥ MISSING'} (count: ${existingExcelCount})`;
                output += `<br>‚è∞ Hour: ${existingHourCount > 0 ? 'üü¢ EXISTS' : 'üî¥ MISSING'} (count: ${existingHourCount})`;
                output += `</div>`;
                
                resultsDiv.innerHTML = output;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result error">‚ùå Test failed: ${error.message}</div>`;
            }
        }
        
        function clearBrowserCache() {
            const keys = Object.keys(localStorage);
            let clearedCount = 0;
            
            keys.forEach(key => {
                if (key.includes('abcd') || key.includes('excel') || key.includes('hour') || key.includes('status')) {
                    localStorage.removeItem(key);
                    clearedCount++;
                    console.log(`üóëÔ∏è Cleared: ${key}`);
                }
            });
            
            resultsDiv.innerHTML = `<div class="test-result success">üóëÔ∏è Cleared ${clearedCount} cache keys. Please refresh the main app and test again.</div>`;
        }
        
        function openMainApp() {
            window.open('http://localhost:5174', '_blank');
        }
        
        // Auto-run test on page load
        window.addEventListener('load', () => {
            setTimeout(runStatusTest, 1000);
        });
    </script>
</body>
</html>
