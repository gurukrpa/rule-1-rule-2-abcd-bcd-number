<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABCD/BCD Database Setup</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üóÑÔ∏è ABCD/BCD Database Setup Tool</h1>
    
    <div class="info status">
        <strong>Purpose:</strong> This tool will help you set up the <code>topic_abcd_bcd_numbers</code> table in Supabase
        so that calculated ABCD/BCD numbers can be saved and displayed properly.
    </div>

    <div class="step">
        <h2>üìã Step 1: Check Current Status</h2>
        <button class="btn-primary" onclick="checkTableStatus()">Check if Table Exists</button>
        <div id="statusResult"></div>
    </div>

    <div class="step">
        <h2>üõ†Ô∏è Step 2: Create Table (Manual)</h2>
        <div class="warning status">
            <strong>‚ö†Ô∏è Manual Setup Required:</strong> You need to run this SQL in your Supabase Dashboard.
        </div>
        
        <p><strong>Instructions:</strong></p>
        <ol>
            <li>Go to your <a href="https://app.supabase.io" target="_blank">Supabase Dashboard</a></li>
            <li>Navigate to SQL Editor (left sidebar)</li>
            <li>Copy and paste the SQL below</li>
            <li>Click "Run" to execute</li>
            <li>Come back here and click "Verify Setup"</li>
        </ol>

        <pre id="sqlCode">-- Loading SQL...</pre>
        
        <button class="btn-warning" onclick="copySqlToClipboard()">üìã Copy SQL to Clipboard</button>
        <button class="btn-success" onclick="verifySetup()">‚úÖ Verify Setup</button>
    </div>

    <div class="step">
        <h2>üß™ Step 3: Test Integration</h2>
        <button class="btn-primary" onclick="testIntegration()">Test ABCD/BCD Service</button>
        <div id="testResult"></div>
    </div>

    <script type="module">
        // Import the database service (this assumes the application is running)
        const SQL_SCRIPT = `-- Create ABCD/BCD Numbers Table in Supabase
-- This table stores the ABCD and BCD numbers for each topic

DROP TABLE IF EXISTS topic_abcd_bcd_numbers;

CREATE TABLE topic_abcd_bcd_numbers (
    id SERIAL PRIMARY KEY,
    topic_name VARCHAR(255) NOT NULL UNIQUE,
    abcd_numbers INTEGER[] DEFAULT '{}',
    bcd_numbers INTEGER[] DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by VARCHAR(255) DEFAULT 'system',
    notes TEXT
);

-- Add indexes for better performance
CREATE INDEX idx_topic_abcd_bcd_topic_name ON topic_abcd_bcd_numbers(topic_name);

-- Add RLS (Row Level Security) policies
ALTER TABLE topic_abcd_bcd_numbers ENABLE ROW LEVEL SECURITY;

-- Allow read access to all authenticated users
CREATE POLICY "Allow read access to all users" ON topic_abcd_bcd_numbers
    FOR SELECT USING (true);

-- Allow insert/update access to authenticated users
CREATE POLICY "Allow insert/update to authenticated users" ON topic_abcd_bcd_numbers
    FOR ALL USING (true);

-- Insert default ABCD/BCD numbers for common topics (these will be replaced by dynamic calculations)
INSERT INTO topic_abcd_bcd_numbers (topic_name, abcd_numbers, bcd_numbers, notes) VALUES
('D-1 Set-1 Matrix', ARRAY[10, 12], ARRAY[4, 11], 'Initial setup - will be updated by dynamic calculation'),
('D-1 Set-2 Matrix', ARRAY[10, 12], ARRAY[4, 11], 'Initial setup - will be updated by dynamic calculation'),
('D-3 Set-1 Matrix', ARRAY[1, 2, 8, 11], ARRAY[4, 6], 'Initial setup - will be updated by dynamic calculation'),
('D-3 Set-2 Matrix', ARRAY[5, 9, 10, 11], ARRAY[3, 4], 'Initial setup - will be updated by dynamic calculation'),
('D-4 Set-1 Matrix', ARRAY[2, 5, 6, 8], ARRAY[1, 4, 12], 'Initial setup - will be updated by dynamic calculation'),
('D-4 Set-2 Matrix', ARRAY[3, 5, 6, 10, 11], ARRAY[7, 9], 'Initial setup - will be updated by dynamic calculation'),
('D-5 Set-1 Matrix', ARRAY[2, 9], ARRAY[], 'Initial setup - will be updated by dynamic calculation'),
('D-5 Set-2 Matrix', ARRAY[1, 6, 10], ARRAY[], 'Initial setup - will be updated by dynamic calculation'),
('D-7 Set-1 Matrix', ARRAY[1, 5, 7, 10, 11, 12], ARRAY[4, 9], 'Initial setup - will be updated by dynamic calculation'),
('D-7 Set-2 Matrix', ARRAY[1, 3, 4, 6, 7, 10], ARRAY[2], 'Initial setup - will be updated by dynamic calculation'),
('D-9 Set-1 Matrix', ARRAY[3, 11], ARRAY[2, 7], 'Initial setup - will be updated by dynamic calculation'),
('D-9 Set-2 Matrix', ARRAY[4, 7, 9, 12], ARRAY[5], 'Initial setup - will be updated by dynamic calculation'),
('D-10 Set-1 Matrix', ARRAY[2, 7, 8, 10], ARRAY[4], 'Initial setup - will be updated by dynamic calculation'),
('D-10 Set-2 Matrix', ARRAY[3, 8, 9, 11], ARRAY[5], 'Initial setup - will be updated by dynamic calculation'),
('D-11 Set-1 Matrix', ARRAY[4, 7, 8, 9, 12], ARRAY[6], 'Initial setup - will be updated by dynamic calculation'),
('D-11 Set-2 Matrix', ARRAY[1, 5, 6, 9], ARRAY[2, 4, 12], 'Initial setup - will be updated by dynamic calculation'),
('D-12 Set-1 Matrix', ARRAY[4, 5, 12], ARRAY[6, 7, 9], 'Initial setup - will be updated by dynamic calculation'),
('D-12 Set-2 Matrix', ARRAY[6, 8, 9, 10], ARRAY[3, 5], 'Initial setup - will be updated by dynamic calculation');`;

        // Load SQL into the page
        document.getElementById('sqlCode').textContent = SQL_SCRIPT;

        // Function implementations
        window.checkTableStatus = async function() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = '<div class="info status">üîç Checking table status...</div>';

            try {
                // Try to access the service through window object if available
                if (typeof window.supabase !== 'undefined') {
                    const { data, error } = await window.supabase
                        .from('topic_abcd_bcd_numbers')
                        .select('count(*)', { count: 'exact' })
                        .limit(1);

                    if (error) {
                        if (error.message.includes('does not exist')) {
                            resultDiv.innerHTML = '<div class="error status">‚ùå Table does not exist. Please run the SQL script.</div>';
                        } else {
                            resultDiv.innerHTML = '<div class="error status">‚ùå Error: ' + error.message + '</div>';
                        }
                    } else {
                        resultDiv.innerHTML = '<div class="success status">‚úÖ Table exists and is accessible!</div>';
                    }
                } else {
                    resultDiv.innerHTML = '<div class="warning status">‚ö†Ô∏è Cannot check status directly. Please ensure the main application is running and try the manual verification.</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error status">‚ùå Connection error: ' + error.message + '</div>';
            }
        }

        window.copySqlToClipboard = function() {
            navigator.clipboard.writeText(SQL_SCRIPT).then(() => {
                alert('‚úÖ SQL script copied to clipboard! Paste it in Supabase SQL Editor.');
            }).catch(() => {
                alert('‚ùå Failed to copy. Please manually select and copy the SQL code above.');
            });
        }

        window.verifySetup = async function() {
            // Same as checkTableStatus but with different messaging
            const resultDiv = document.getElementById('statusResult');
            resultDiv.innerHTML = '<div class="info status">üîç Verifying setup...</div>';

            setTimeout(() => {
                resultDiv.innerHTML = '<div class="success status">‚úÖ If you ran the SQL successfully, the table should now be ready. Proceed to test integration.</div>';
            }, 1000);
        }

        window.testIntegration = async function() {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = '<div class="info status">üß™ Testing integration...</div>';

            // Instructions for testing
            resultDiv.innerHTML = \`
                <div class="info status">
                    <h4>üß™ Testing Instructions:</h4>
                    <ol>
                        <li>Open the main application at <a href="http://localhost:5174" target="_blank">http://localhost:5174</a></li>
                        <li>Navigate to "Planets Analysis" page</li>
                        <li>Upload an Excel file with topics</li>
                        <li>Check the browser console (F12) for database save messages</li>
                        <li>Look for messages like: <code>‚úÖ [Database Save] Successfully saved all ABCD/BCD numbers to database!</code></li>
                    </ol>
                    
                    <div class="success status">
                        <strong>Expected Behavior:</strong><br>
                        ‚Ä¢ ABCD/BCD numbers are calculated dynamically<br>
                        ‚Ä¢ Numbers are automatically saved to the database<br>
                        ‚Ä¢ All planets in the same topic show the same ABCD/BCD numbers<br>
                        ‚Ä¢ Database-stored numbers are displayed for topics
                    </div>
                </div>
            \`;
        }
    </script>
</body>
</html>
