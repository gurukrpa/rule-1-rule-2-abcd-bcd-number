<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleanup Orphaned Data</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 10px 5px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #005a82; }
        .cleanup-btn { background: #dc3545; }
        .cleanup-btn:hover { background: #c82333; }
        .results { white-space: pre-wrap; font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 15px; border: 1px solid #e9ecef; border-radius: 4px; max-height: 400px; overflow-y: auto; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Cleanup Orphaned Data</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è Issue Detected:</strong> You have orphaned entries in rule2_analysis_results table under UUID user that are preventing you from adding July 3rd.
        </div>
        
        <div class="section">
            <h3>üéØ Quick Fixes</h3>
            <button onclick="cleanupJuly3rd()" class="cleanup-btn">üóëÔ∏è Delete July 3rd Orphan</button>
            <button onclick="cleanupAllUUID()" class="cleanup-btn">üóëÔ∏è Delete All UUID User Data</button>
            <button onclick="transferUUIDToSingMaya()">üì§ Transfer UUID Data to 'sing maya'</button>
        </div>
        
        <div class="section">
            <button onclick="checkCurrentState()">üìä Check Current State</button>
            <button onclick="verifyUserDates()">‚úÖ Verify sing maya Dates</button>
        </div>
        
        <div id="results" class="results" style="display: none;"></div>
    </div>

    <script type="module">
        import { supabase } from './src/supabaseClient.js';
        
        window.supabase = supabase;
        
        window.cleanupJuly3rd = async function() {
            if (!confirm('‚ö†Ô∏è Delete July 3rd entry from rule2_analysis_results? This will allow you to add July 3rd again.')) {
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'üßπ Cleaning up July 3rd orphan...\n';
            
            try {
                const { error } = await supabase
                    .from('rule2_analysis_results')
                    .delete()
                    .eq('analysis_date', '2025-07-03');
                    
                if (error) {
                    resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ July 3rd orphan deleted successfully!\n';
                    resultsDiv.textContent += 'üéâ You can now try adding July 3rd again.\n';
                }
            } catch (error) {
                resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
            }
        };
        
        window.cleanupAllUUID = async function() {
            if (!confirm('‚ö†Ô∏è Delete ALL data for UUID user (5019aa9a-a653-49f5-b7da-f5bc9dcde985)?\n\nThis will remove 7 entries from rule2_analysis_results.')) {
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'üßπ Cleaning up all UUID user data...\n';
            
            try {
                const uuidUser = '5019aa9a-a653-49f5-b7da-f5bc9dcde985';
                
                // Delete from rule2_analysis_results
                const { error: analysisError } = await supabase
                    .from('rule2_analysis_results')
                    .delete()
                    .eq('user_id', uuidUser);
                    
                if (analysisError) {
                    resultsDiv.textContent += `‚ùå Analysis delete error: ${analysisError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Deleted all rule2_analysis_results for UUID user\n';
                }
                
                // Delete from excel_uploads
                const { error: excelError } = await supabase
                    .from('excel_uploads')
                    .delete()
                    .eq('user_id', uuidUser);
                    
                if (excelError) {
                    resultsDiv.textContent += `‚ùå Excel delete error: ${excelError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Deleted all excel_uploads for UUID user\n';
                }
                
                // Delete from hour_entries
                const { error: hourError } = await supabase
                    .from('hour_entries')
                    .delete()
                    .eq('user_id', uuidUser);
                    
                if (hourError) {
                    resultsDiv.textContent += `‚ùå Hour entries delete error: ${hourError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Deleted all hour_entries for UUID user\n';
                }
                
                // Delete from user_dates_abcd
                const { error: userDatesError } = await supabase
                    .from('user_dates_abcd')
                    .delete()
                    .eq('user_id', uuidUser);
                    
                if (userDatesError) {
                    resultsDiv.textContent += `‚ùå User dates delete error: ${userDatesError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Deleted user_dates_abcd for UUID user\n';
                }
                
                resultsDiv.textContent += '\nüéâ All UUID user data cleaned up!\n';
                
            } catch (error) {
                resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
            }
        };
        
        window.transferUUIDToSingMaya = async function() {
            if (!confirm('üì§ Transfer all UUID user data to "sing maya"?\n\nThis will move 7 analysis results to your current user.')) {
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'üì§ Transferring UUID data to sing maya...\n';
            
            try {
                const uuidUser = '5019aa9a-a653-49f5-b7da-f5bc9dcde985';
                const targetUser = 'sing maya';
                
                // Update rule2_analysis_results
                const { error: analysisError } = await supabase
                    .from('rule2_analysis_results')
                    .update({ user_id: targetUser })
                    .eq('user_id', uuidUser);
                    
                if (analysisError) {
                    resultsDiv.textContent += `‚ùå Analysis transfer error: ${analysisError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Transferred rule2_analysis_results to sing maya\n';
                }
                
                // Update excel_uploads
                const { error: excelError } = await supabase
                    .from('excel_uploads')
                    .update({ user_id: targetUser })
                    .eq('user_id', uuidUser);
                    
                if (excelError) {
                    resultsDiv.textContent += `‚ùå Excel transfer error: ${excelError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Transferred excel_uploads to sing maya\n';
                }
                
                // Update hour_entries  
                const { error: hourError } = await supabase
                    .from('hour_entries')
                    .update({ user_id: targetUser })
                    .eq('user_id', uuidUser);
                    
                if (hourError) {
                    resultsDiv.textContent += `‚ùå Hour entries transfer error: ${hourError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Transferred hour_entries to sing maya\n';
                }
                
                // Update user_dates_abcd
                const { error: userDatesError } = await supabase
                    .from('user_dates_abcd')
                    .update({ user_id: targetUser })
                    .eq('user_id', uuidUser);
                    
                if (userDatesError) {
                    resultsDiv.textContent += `‚ùå User dates transfer error: ${userDatesError.message}\n`;
                } else {
                    resultsDiv.textContent += '‚úÖ Transferred user_dates_abcd to sing maya\n';
                }
                
                resultsDiv.textContent += '\nüéâ All data transferred to sing maya!\n';
                resultsDiv.textContent += '‚ö†Ô∏è Note: You may need to refresh your app to see all the transferred dates.\n';
                
            } catch (error) {
                resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
            }
        };
        
        window.checkCurrentState = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'üîç Checking current database state...\n';
            
            try {
                // Check rule2_analysis_results
                const { data: analysisData, error: analysisError } = await supabase
                    .from('rule2_analysis_results')
                    .select('user_id, analysis_date')
                    .order('analysis_date');
                    
                if (analysisError) {
                    resultsDiv.textContent += `‚ùå Error: ${analysisError.message}\n`;
                } else {
                    resultsDiv.textContent += `\nüìä RULE2_ANALYSIS_RESULTS (${analysisData.length} entries):\n`;
                    
                    const byUser = analysisData.reduce((acc, entry) => {
                        if (!acc[entry.user_id]) acc[entry.user_id] = [];
                        acc[entry.user_id].push(entry.analysis_date);
                        return acc;
                    }, {});
                    
                    Object.entries(byUser).forEach(([userId, dates]) => {
                        resultsDiv.textContent += `  üë§ ${userId}: ${dates.join(', ')}\n`;
                    });
                }
                
                // Check user_dates_abcd
                const { data: userDatesData, error: userDatesError } = await supabase
                    .from('user_dates_abcd')
                    .select('user_id, dates');
                    
                if (userDatesError) {
                    resultsDiv.textContent += `‚ùå Error: ${userDatesError.message}\n`;
                } else {
                    resultsDiv.textContent += `\nüìÖ USER_DATES_ABCD:\n`;
                    userDatesData.forEach(entry => {
                        const dates = Array.isArray(entry.dates) ? entry.dates : [];
                        resultsDiv.textContent += `  üë§ ${entry.user_id}: ${dates.join(', ')}\n`;
                    });
                }
                
            } catch (error) {
                resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
            }
        };
        
        window.verifyUserDates = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = '‚úÖ Verifying sing maya dates...\n';
            
            try {
                const { data: userData, error } = await supabase
                    .from('user_dates_abcd')
                    .select('dates')
                    .eq('user_id', 'sing maya')
                    .single();
                    
                if (error) {
                    resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
                } else if (userData && Array.isArray(userData.dates)) {
                    resultsDiv.textContent += `üìÖ sing maya has ${userData.dates.length} dates:\n`;
                    resultsDiv.textContent += userData.dates.join(', ') + '\n';
                    
                    if (userData.dates.includes('2025-07-03')) {
                        resultsDiv.textContent += '‚ö†Ô∏è July 3rd is in user_dates_abcd\n';
                    } else {
                        resultsDiv.textContent += '‚úÖ July 3rd is NOT in user_dates_abcd (good)\n';
                    }
                } else {
                    resultsDiv.textContent += '‚ùå No dates found for sing maya\n';
                }
            } catch (error) {
                resultsDiv.textContent += `‚ùå Error: ${error.message}\n`;
            }
        };
    </script>
</body>
</html>
