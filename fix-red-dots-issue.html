<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Red Dots Issue - Live Diagnostic & Fix</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        .diagnostic-section { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .code { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; padding: 10px; font-family: monospace; margin: 10px 0; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .solution-box { background: #e8f5e8; border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Red Dots Issue - Live Diagnostic & Fix</h1>
        
        <div class="diagnostic-section error">
            <h2>ğŸš¨ Current Problem</h2>
            <p><strong>Issue:</strong> Topic selector shows red dots (â—‹) instead of green dots (â—)</p>
            <p><strong>Meaning:</strong> <code>getTopicNumbersWithNormalization()</code> returns empty ABCD/BCD arrays</p>
            <p><strong>Impact:</strong> No ABCD/BCD badges appear in the planet matrix</p>
        </div>

        <div class="diagnostic-section info">
            <h2>ğŸ” Data Source Analysis</h2>
            <p>The system checks 3 data sources in priority order:</p>
            <ol>
                <li><strong>Real Analysis Data</strong> - From Rule2CompactPage/PastDays analysis</li>
                <li><strong>Database Numbers</strong> - From Supabase storage</li>
                <li><strong>Fallback Numbers</strong> - From hardcoded TOPIC_NUMBERS object</li>
            </ol>
            <button onclick="checkDataSources()">ğŸ” Check Data Sources</button>
        </div>

        <div class="diagnostic-section">
            <h2>ğŸ”§ Live Diagnostic Tools</h2>
            <button onclick="checkCurrentState()">1. Check Current State</button>
            <button onclick="checkRealAnalysisData()">2. Check Real Analysis Data</button>
            <button onclick="checkDatabaseData()">3. Check Database Data</button>
            <button onclick="checkFallbackData()">4. Check Fallback Data</button>
            <button onclick="testTopicLookup()">5. Test Topic Lookup</button>
            <button onclick="runFullDiagnostic()">ğŸš€ Run Full Diagnostic</button>
        </div>

        <div id="diagnosticResults" class="diagnostic-section" style="display: none;">
            <h2>ğŸ“Š Diagnostic Results</h2>
            <div id="results"></div>
        </div>

        <div class="solution-box">
            <h2>ğŸš€ IMMEDIATE SOLUTION</h2>
            <div class="step">
                <h3>Step 1: Navigate to Rule2CompactPage</h3>
                <p>The most common cause is missing real analysis data. You need to run Rule2 analysis first:</p>
                <ol>
                    <li>Go to <strong>Rule2CompactPage</strong></li>
                    <li>Select dates with at least 4 days of data</li>
                    <li>Select HR period (1-24)</li>
                    <li>Click <strong>"Analyze ABCD-BCD Numbers"</strong></li>
                    <li>Wait for analysis to complete</li>
                    <li>Return to Planets Analysis page</li>
                </ol>
                <button onclick="openRule2Page()">ğŸ”— Go to Rule2CompactPage</button>
            </div>

            <div class="step">
                <h3>Step 2: Verify Green Dots Appear</h3>
                <p>After running Rule2 analysis, return to Planets Analysis page and verify:</p>
                <ul>
                    <li>âœ… Topic selector shows green dots (â—) instead of red dots (â—‹)</li>
                    <li>âœ… Console shows "Using REAL ANALYSIS numbers"</li>
                    <li>âœ… ABCD/BCD badges appear in planet matrix</li>
                </ul>
                <button onclick="refreshPlanetsPage()">ğŸ”„ Refresh Planets Analysis</button>
            </div>

            <div class="step">
                <h3>Alternative: Check User Configuration</h3>
                <p>If Step 1 doesn't work, the issue might be user-specific:</p>
                <button onclick="checkUserConfig()">ğŸ‘¤ Check User Configuration</button>
                <button onclick="suggestUserSwitch()">ğŸ”„ Suggest User Switch</button>
            </div>
        </div>

        <div class="diagnostic-section warning">
            <h2>ğŸ”§ Manual Console Testing</h2>
            <p>Open browser console on Planets Analysis page and run:</p>
            <div class="code">
// Check real analysis data
console.log('Real Analysis Data:', window.realAnalysisData);

// Check database data  
console.log('Database Data:', window.databaseTopicNumbers);

// Test topic lookup
if (typeof getTopicNumbers === 'function') {
    console.log('D-1 Set-1 Matrix:', getTopicNumbers('D-1 Set-1 Matrix'));
    console.log('D-1 Set-1:', getTopicNumbers('D-1 Set-1'));
}

// Check available topics
console.log('Available Topics:', window.availableTopics);
            </div>
        </div>

        <div class="diagnostic-section info">
            <h2>ğŸ“‹ Expected Results After Fix</h2>
            <ul>
                <li>âœ… <strong>Green dots (â—)</strong> in topic selector</li>
                <li>âœ… <strong>ABCD/BCD badges</strong> in planet matrix display</li>
                <li>âœ… <strong>Console messages:</strong> "Using REAL ANALYSIS numbers" or "Using FALLBACK numbers"</li>
                <li>âœ… <strong>Hour switching</strong> works without losing data</li>
                <li>âœ… <strong>Topic count</strong> shows populated data in diagnostics</li>
            </ul>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const resultDiv = document.getElementById('diagnosticResults');
            
            const color = type === 'success' ? '#28a745' : 
                         type === 'error' ? '#dc3545' : 
                         type === 'warning' ? '#ffc107' : '#007bff';
            
            results.innerHTML += `<div style="color: ${color}; margin: 5px 0;">${message}</div>`;
            resultDiv.style.display = 'block';
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function checkCurrentState() {
            clearResults();
            log('ğŸ” Checking current page state...', 'info');
            
            // Check if we're on the right page
            const currentPath = window.location.pathname + window.location.search;
            log(`Current URL: ${currentPath}`, 'info');
            
            // Check for React root
            const reactRoot = document.getElementById('root');
            if (reactRoot) {
                log('âœ… React app detected', 'success');
                log(`React content loaded: ${reactRoot.innerHTML.length > 0 ? 'Yes' : 'No'}`, 
                    reactRoot.innerHTML.length > 0 ? 'success' : 'warning');
            } else {
                log('âŒ React root element not found', 'error');
                log('ğŸ’¡ Make sure you\'re on the Planets Analysis page', 'warning');
            }
            
            // Check for development server
            if (currentPath.includes('localhost') || currentPath.includes('5173')) {
                log('âœ… Development server detected', 'success');
            } else {
                log('âš ï¸ Not on development server', 'warning');
            }
        }

        function checkRealAnalysisData() {
            clearResults();
            log('ğŸ” Checking real analysis data...', 'info');
            
            if (typeof window.realAnalysisData !== 'undefined') {
                const data = window.realAnalysisData;
                if (data && data.topicNumbers) {
                    const topicCount = Object.keys(data.topicNumbers).length;
                    log(`âœ… Real analysis data found with ${topicCount} topics`, 'success');
                    log(`Data source: ${data.source || 'Unknown'}`, 'info');
                    
                    // Check if data has meaningful numbers
                    const hasValidData = Object.values(data.topicNumbers).some(topic => 
                        (topic.abcd && topic.abcd.length > 0) || (topic.bcd && topic.bcd.length > 0)
                    );
                    
                    if (hasValidData) {
                        log('âœ… Real analysis data contains valid ABCD/BCD numbers', 'success');
                        log('ğŸ’¡ This should show green dots! Check console for lookup issues.', 'info');
                    } else {
                        log('âš ï¸ Real analysis data exists but contains no valid numbers', 'warning');
                        log('ğŸ’¡ Data may be marked as incomplete', 'warning');
                    }
                    
                    // Test specific topic
                    const d1set1 = data.topicNumbers['D-1 Set-1 Matrix'] || data.topicNumbers['D-1 Set-1'];
                    if (d1set1) {
                        log(`ğŸ“Š D-1 Set-1 sample: ABCD:[${d1set1.abcd || []}] BCD:[${d1set1.bcd || []}]`, 'info');
                    }
                } else {
                    log('âŒ Real analysis data found but no topicNumbers', 'error');
                }
            } else {
                log('âŒ No real analysis data found', 'error');
                log('ğŸ’¡ SOLUTION: Run Rule2CompactPage analysis first', 'warning');
            }
        }

        function checkDatabaseData() {
            clearResults();
            log('ğŸ” Checking database data...', 'info');
            
            if (typeof window.databaseTopicNumbers !== 'undefined') {
                const data = window.databaseTopicNumbers;
                if (data && data.topicNumbers) {
                    const topicCount = Object.keys(data.topicNumbers).length;
                    log(`âœ… Database data found with ${topicCount} topics`, 'success');
                } else {
                    log('âŒ Database data structure invalid', 'error');
                }
            } else {
                log('âŒ No database data found', 'error');
                log('ğŸ’¡ This is normal if no data stored in Supabase yet', 'info');
            }
        }

        function checkFallbackData() {
            clearResults();
            log('ğŸ” Checking fallback TOPIC_NUMBERS data...', 'info');
            
            log('ğŸ’¡ Fallback data is hardcoded in component', 'info');
            log('Expected topics in TOPIC_NUMBERS:', 'info');
            const expectedTopics = [
                'D-1 Set-1 Matrix', 'D-1 Set-2 Matrix',
                'D-3 Set-1 Matrix', 'D-3 Set-2 Matrix',
                'D-4 Set-1 Matrix', 'D-4 Set-2 Matrix',
                // ... continues for all 30 topics
            ];
            
            expectedTopics.slice(0, 6).forEach(topic => {
                log(`  - ${topic}`, 'info');
            });
            log('  - ... and 24 more topics', 'info');
            
            log('âœ… Fallback data should always work as last resort', 'success');
            log('ğŸ’¡ If still seeing red dots, there\'s a topic name mismatch', 'warning');
        }

        function testTopicLookup() {
            clearResults();
            log('ğŸ” Testing topic lookup function...', 'info');
            
            if (typeof getTopicNumbers === 'function') {
                log('âœ… getTopicNumbers function found', 'success');
                
                // Test common topics
                const testTopics = ['D-1 Set-1 Matrix', 'D-1 Set-1', 'D-3 Set-1 Matrix'];
                testTopics.forEach(topic => {
                    try {
                        const result = getTopicNumbers(topic);
                        const hasData = result.abcd.length > 0 || result.bcd.length > 0;
                        log(`${topic}: ${hasData ? 'âœ…' : 'âŒ'} ABCD:${result.abcd.length} BCD:${result.bcd.length}`, 
                            hasData ? 'success' : 'error');
                    } catch (e) {
                        log(`${topic}: âŒ Error: ${e.message}`, 'error');
                    }
                });
            } else {
                log('âŒ getTopicNumbers function not found', 'error');
                log('ğŸ’¡ Make sure you\'re on the Planets Analysis page', 'warning');
            }
        }

        function checkDataSources() {
            clearResults();
            log('ğŸ” Checking all data sources...', 'info');
            
            checkRealAnalysisData();
            setTimeout(() => checkDatabaseData(), 500);
            setTimeout(() => checkFallbackData(), 1000);
        }

        function runFullDiagnostic() {
            clearResults();
            log('ğŸš€ Running full diagnostic...', 'info');
            
            checkCurrentState();
            setTimeout(() => checkRealAnalysisData(), 500);
            setTimeout(() => checkDatabaseData(), 1000);
            setTimeout(() => checkFallbackData(), 1500);
            setTimeout(() => testTopicLookup(), 2000);
            setTimeout(() => {
                log('', 'info');
                log('ğŸ¯ DIAGNOSTIC COMPLETE', 'success');
                log('ğŸ’¡ Most likely solution: Run Rule2CompactPage analysis first', 'warning');
            }, 2500);
        }

        function checkUserConfig() {
            clearResults();
            log('ğŸ‘¤ Checking user configuration...', 'info');
            
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const hr = urlParams.get('hr');
            
            if (userId) {
                log(`âœ… User ID found: ${userId}`, 'success');
            } else {
                log('âŒ No user ID in URL parameters', 'error');
                log('ğŸ’¡ Add ?user=your-user-id to URL', 'warning');
            }
            
            if (hr) {
                log(`âœ… HR parameter found: ${hr}`, 'success');
            } else {
                log('âš ï¸ No HR parameter in URL', 'warning');
                log('ğŸ’¡ Add &hr=your-hr-number to URL', 'info');
            }
        }

        function suggestUserSwitch() {
            clearResults();
            log('ğŸ”„ User switch suggestions...', 'info');
            
            const workingUsers = [
                '8db9861a-76ce-4ae3-81b0-7a8b82314ef2',
                'e57d8c46-0186-4749-b18d-9e170aaa5fce',
                '2dc97157-e7d5-43b2-93b2-ee3c6252b3dd'
            ];
            
            log('Known working users with complete data:', 'info');
            workingUsers.forEach((userId, index) => {
                log(`${index + 1}. ${userId}`, 'info');
            });
            
            log('ğŸ’¡ Try switching to one of these users if current user has insufficient data', 'warning');
        }

        function openRule2Page() {
            const baseUrl = window.location.origin;
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const hr = urlParams.get('hr');
            
            let rule2Url = `${baseUrl}/#/rule2`;
            if (userId) rule2Url += `?user=${userId}`;
            if (hr) rule2Url += `${userId ? '&' : '?'}hr=${hr}`;
            
            window.open(rule2Url, '_blank');
        }

        function refreshPlanetsPage() {
            window.location.reload();
        }

        // Auto-run basic diagnostic on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ğŸ” Page loaded - running initial diagnostic...', 'info');
                checkCurrentState();
            }, 1000);
        });
    </script>
</body>
</html>
