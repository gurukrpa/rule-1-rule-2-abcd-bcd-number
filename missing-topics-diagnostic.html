<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missing Topics Diagnostic Tool</title>
    <style>
        body {
            font-family: monospace;
            background: #f0f0f0;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .diagnostic-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .error { background: #f8d7da; border-color: #f1c0c7; }
        .info { background: #d1ecf1; border-color: #b6d7ff; }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 14px;
        }
        .result-box {
            background: #ffffff;
            border: 2px solid #007bff;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            min-height: 100px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .step {
            background: #e9ecef;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
        }
        .findings {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Missing Topics Diagnostic Tool</h1>
        <div class="diagnostic-section info">
            <h3>üìã Issue Summary</h3>
            <p><strong>Problem:</strong> Only 7 topic groups showing instead of 30 topics</p>
            <p><strong>Date:</strong> 26/06/2025 (trigger date)</p>
            <p><strong>Missing:</strong> D-3, D-5, D-7, D-10, D-12, D-27, D-30, D-60</p>
            <p><strong>Showing:</strong> D-1, D-4, D-9, D-11, D-81, D-108, D-144</p>
        </div>

        <div class="diagnostic-section warning">
            <h3>üéØ Database Analysis Results</h3>
            <p><strong>Key Finding:</strong> Excel data IS complete for most users!</p>
            <ul>
                <li>‚úÖ 3 users have complete 30 topics (all 15 D-numbers)</li>
                <li>‚ùå 1 user (`planets-test-user-2025`) has incomplete data</li>
                <li>üîç <strong>This suggests the issue is USER-SPECIFIC, not systemic</strong></li>
            </ul>
        </div>

        <div class="step">
            <h3>üì± STEP 1: Check Current User Context</h3>
            <p>First, let's identify which user you're currently logged in as and what data they have.</p>
            <button onclick="checkCurrentUser()">üîç Check Current User</button>
            <div id="userResult" class="result-box"></div>
        </div>

        <div class="step">
            <h3>üìä STEP 2: Analyze User's Excel Data</h3>
            <p>Check the actual Excel data structure for your current user on the trigger date.</p>
            <button onclick="analyzeUserExcelData()">üìä Analyze Excel Data</button>
            <div id="excelResult" class="result-box"></div>
        </div>

        <div class="step">
            <h3>‚è∞ STEP 3: Check Hour Entry Data</h3>
            <p>Verify that Hour Entry data exists for the trigger date.</p>
            <button onclick="checkHourData()">‚è∞ Check Hour Data</button>
            <div id="hourResult" class="result-box"></div>
        </div>

        <div class="step">
            <h3>üîÑ STEP 4: Test Data Pipeline</h3>
            <p>Test the actual data loading pipeline used by the components.</p>
            <button onclick="testDataPipeline()">üîÑ Test Data Pipeline</button>
            <div id="pipelineResult" class="result-box"></div>
        </div>

        <div class="step">
            <h3>üéØ STEP 5: Check Topic Filtering</h3>
            <p>Analyze topic filtering and TOPIC_ORDER arrays across components.</p>
            <button onclick="checkTopicFiltering()">üéØ Check Topic Filtering</button>
            <div id="filteringResult" class="result-box"></div>
        </div>

        <div class="findings">
            <h3>üéØ Quick Solutions Based on Findings</h3>
            <div id="quickSolutions">
                <p>Run the diagnostics above to get personalized solutions...</p>
            </div>
        </div>

        <div class="step">
            <h3>üîß STEP 6: Apply Fix (if needed)</h3>
            <p>Based on the diagnostic results, apply the appropriate fix.</p>
            <button onclick="showFixOptions()">üîß Show Fix Options</button>
            <div id="fixOptions" class="result-box"></div>
        </div>
    </div>

    <script>
        let diagnosticResults = {};

        function checkCurrentUser() {
            const resultDiv = document.getElementById('userResult');
            resultDiv.innerHTML = '<p>üîç Checking current user context...</p>';

            try {
                // Get current user from various possible sources
                const currentUser = window.selectedUser || 
                                  (window.user && window.user.id) ||
                                  localStorage.getItem('selectedUser') ||
                                  'NOT_FOUND';

                diagnosticResults.currentUser = currentUser;

                let result = `<h4>üë§ Current User Analysis</h4>`;
                result += `<p><strong>User ID:</strong> ${currentUser}</p>`;

                // Check if this is the problematic test user
                if (currentUser === 'planets-test-user-2025') {
                    result += `<div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 10px 0;">`;
                    result += `<h4>üö® PROBLEM IDENTIFIED!</h4>`;
                    result += `<p>You're logged in as the test user that has incomplete data.</p>`;
                    result += `<p><strong>This user only has 1 set (0 D-numbers) in the database.</strong></p>`;
                    result += `<p><strong>Solution:</strong> Switch to a different user or re-upload complete Excel data.</p>`;
                    result += `</div>`;
                } else if (currentUser === 'NOT_FOUND') {
                    result += `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">`;
                    result += `<h4>‚ö†Ô∏è No User Selected</h4>`;
                    result += `<p>Cannot find current user. Please select a user in the application.</p>`;
                    result += `</div>`;
                } else {
                    result += `<div style="background: #d4edda; padding: 10px; border-radius: 5px; margin: 10px 0;">`;
                    result += `<h4>‚úÖ User Found</h4>`;
                    result += `<p>This user should have complete data according to our database analysis.</p>`;
                    result += `</div>`;
                }

                // Check available users
                if (window.users && Array.isArray(window.users)) {
                    result += `<h4>üë• Available Users:</h4>`;
                    window.users.forEach(user => {
                        const isSelected = user.id === currentUser;
                        result += `<p>${isSelected ? 'üëâ' : '  '} ${user.name || user.id} (${user.id})</p>`;
                    });
                }

                resultDiv.innerHTML = result;
                updateQuickSolutions();

            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #f8d7da; padding: 10px;">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function analyzeUserExcelData() {
            const resultDiv = document.getElementById('excelResult');
            resultDiv.innerHTML = '<p>üìä Analyzing Excel data...</p>';

            try {
                const currentUser = diagnosticResults.currentUser || window.selectedUser || 'unknown';
                const targetDate = '2025-06-26';

                // Try to get Excel data using CleanSupabaseService
                if (typeof cleanSupabaseService !== 'undefined') {
                    const excelData = await cleanSupabaseService.getExcelData(currentUser, targetDate);
                    
                    let result = `<h4>üìä Excel Data Analysis</h4>`;
                    result += `<p><strong>User:</strong> ${currentUser}</p>`;
                    result += `<p><strong>Date:</strong> ${targetDate}</p>`;

                    if (!excelData) {
                        result += `<div style="background: #f8d7da; padding: 10px; border-radius: 5px;">`;
                        result += `<h4>‚ùå NO EXCEL DATA FOUND</h4>`;
                        result += `<p>This user has no Excel data for the trigger date.</p>`;
                        result += `<p><strong>Solution:</strong> Upload Excel file for this date.</p>`;
                        result += `</div>`;
                        diagnosticResults.hasExcelData = false;
                    } else {
                        const sets = excelData.sets || {};
                        const setNames = Object.keys(sets);
                        
                        // Extract D-numbers
                        const dNumbers = new Set();
                        setNames.forEach(setName => {
                            const match = setName.match(/D-(\\d+)/);
                            if (match) {
                                dNumbers.add(parseInt(match[1]));
                            }
                        });

                        const sortedDNumbers = Array.from(dNumbers).sort((a, b) => a - b);
                        
                        result += `<div style="background: #d4edda; padding: 10px; border-radius: 5px;">`;
                        result += `<h4>‚úÖ Excel Data Found</h4>`;
                        result += `<p><strong>Total Sets:</strong> ${setNames.length}</p>`;
                        result += `<p><strong>D-numbers:</strong> ${sortedDNumbers.join(', ')}</p>`;
                        result += `<p><strong>Unique D-numbers:</strong> ${sortedDNumbers.length}</p>`;
                        result += `</div>`;

                        // Check for the issue
                        if (sortedDNumbers.length === 7) {
                            result += `<div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin-top: 10px;">`;
                            result += `<h4>üö® PROBLEM CONFIRMED</h4>`;
                            result += `<p>Excel data only contains 7 D-numbers (should be 15).</p>`;
                            result += `<p>This gives 14 topics instead of 30.</p>`;
                            result += `<p><strong>Missing D-numbers:</strong> 3,5,7,10,12,27,30,60</p>`;
                            result += `</div>`;
                        } else if (sortedDNumbers.length === 15) {
                            result += `<div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;">`;
                            result += `<h4>ü§î DATA IS COMPLETE</h4>`;
                            result += `<p>Excel data contains all 15 D-numbers (30 topics).</p>`;
                            result += `<p>The issue must be in the frontend processing.</p>`;
                            result += `</div>`;
                        }

                        diagnosticResults.hasExcelData = true;
                        diagnosticResults.dNumbersCount = sortedDNumbers.length;
                        diagnosticResults.setCount = setNames.length;
                    }

                    resultDiv.innerHTML = result;
                } else {
                    resultDiv.innerHTML = '<div style="background: #f8d7da; padding: 10px;">‚ùå CleanSupabaseService not available</div>';
                }

                updateQuickSolutions();

            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #f8d7da; padding: 10px;">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function checkHourData() {
            const resultDiv = document.getElementById('hourResult');
            resultDiv.innerHTML = '<p>‚è∞ Checking Hour Entry data...</p>';

            try {
                const currentUser = diagnosticResults.currentUser || window.selectedUser || 'unknown';
                const targetDate = '2025-06-26';

                if (typeof cleanSupabaseService !== 'undefined') {
                    const hourData = await cleanSupabaseService.getHourEntry(currentUser, targetDate);
                    
                    let result = `<h4>‚è∞ Hour Entry Analysis</h4>`;

                    if (!hourData) {
                        result += `<div style="background: #f8d7da; padding: 10px; border-radius: 5px;">`;
                        result += `<h4>‚ùå NO HOUR DATA FOUND</h4>`;
                        result += `<p>This user has no Hour Entry data for the trigger date.</p>`;
                        result += `</div>`;
                        diagnosticResults.hasHourData = false;
                    } else {
                        const planetSelections = hourData.planetSelections || {};
                        const hrCount = Object.keys(planetSelections).length;
                        
                        result += `<div style="background: #d4edda; padding: 10px; border-radius: 5px;">`;
                        result += `<h4>‚úÖ Hour Data Found</h4>`;
                        result += `<p><strong>HR Selections:</strong> ${hrCount}</p>`;
                        result += `<p><strong>Hours:</strong> ${Object.keys(planetSelections).join(', ')}</p>`;
                        result += `</div>`;

                        diagnosticResults.hasHourData = true;
                        diagnosticResults.hrCount = hrCount;
                    }

                    resultDiv.innerHTML = result;
                } else {
                    resultDiv.innerHTML = '<div style="background: #f8d7da; padding: 10px;">‚ùå CleanSupabaseService not available</div>';
                }

                updateQuickSolutions();

            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #f8d7da; padding: 10px;">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testDataPipeline() {
            const resultDiv = document.getElementById('pipelineResult');
            resultDiv.innerHTML = '<p>üîÑ Testing data pipeline...</p>';

            try {
                const currentUser = diagnosticResults.currentUser || window.selectedUser || 'unknown';
                
                let result = `<h4>üîÑ Data Pipeline Test</h4>`;

                // Test if we can access the same data that the components use
                if (typeof dateDataCache !== 'undefined') {
                    result += `<p><strong>dateDataCache:</strong> Available (${dateDataCache.size} entries)</p>`;
                    
                    if (dateDataCache.size > 0) {
                        const cacheKeys = Array.from(dateDataCache.keys());
                        result += `<p><strong>Cache Keys:</strong> ${cacheKeys.join(', ')}</p>`;
                        
                        // Check if our target date is cached
                        const targetDate = '2025-06-26';
                        const cachedData = dateDataCache.get(targetDate);
                        if (cachedData) {
                            const setsCount = Object.keys(cachedData.sets || {}).length;
                            result += `<div style="background: #d4edda; padding: 10px; margin: 10px 0;">`;
                            result += `<p><strong>Target Date Cache:</strong> Found</p>`;
                            result += `<p><strong>Sets Count:</strong> ${setsCount}</p>`;
                            result += `</div>`;
                        } else {
                            result += `<div style="background: #fff3cd; padding: 10px; margin: 10px 0;">`;
                            result += `<p><strong>Target Date Cache:</strong> Not found</p>`;
                            result += `</div>`;
                        }
                    }
                } else {
                    result += `<p><strong>dateDataCache:</strong> Not available (not on Rule2CompactPage)</p>`;
                }

                // Check IndexPage data structures
                if (typeof allDaysData !== 'undefined') {
                    result += `<p><strong>allDaysData:</strong> Available</p>`;
                    const dataKeys = Object.keys(allDaysData);
                    result += `<p><strong>Data Keys:</strong> ${dataKeys.join(', ')}</p>`;
                } else {
                    result += `<p><strong>allDaysData:</strong> Not available (not on IndexPage)</p>`;
                }

                resultDiv.innerHTML = result;

            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #f8d7da; padding: 10px;">‚ùå Error: ${error.message}</div>`;
            }
        }

        function checkTopicFiltering() {
            const resultDiv = document.getElementById('filteringResult');
            resultDiv.innerHTML = '<p>üéØ Checking topic filtering...</p>';

            try {
                let result = `<h4>üéØ Topic Filtering Analysis</h4>`;

                // Check TOPIC_ORDER arrays
                if (typeof TOPIC_ORDER !== 'undefined') {
                    result += `<div style="background: #d4edda; padding: 10px; margin: 10px 0;">`;
                    result += `<p><strong>TOPIC_ORDER:</strong> Available (${TOPIC_ORDER.length} topics)</p>`;
                    result += `<p><strong>First 5:</strong> ${TOPIC_ORDER.slice(0, 5).join(', ')}</p>`;
                    result += `</div>`;
                } else {
                    result += `<p><strong>TOPIC_ORDER:</strong> Not available in current scope</p>`;
                }

                // Check available topics
                if (typeof availableTopics !== 'undefined') {
                    result += `<div style="background: #d4edda; padding: 10px; margin: 10px 0;">`;
                    result += `<p><strong>availableTopics:</strong> ${availableTopics.length} topics</p>`;
                    result += `<p><strong>Topics:</strong> ${availableTopics.slice(0, 10).join(', ')}${availableTopics.length > 10 ? '...' : ''}</p>`;
                    result += `</div>`;
                } else {
                    result += `<p><strong>availableTopics:</strong> Not available in current scope</p>`;
                }

                // Check selected topics
                if (typeof selectedTopics !== 'undefined') {
                    result += `<p><strong>selectedTopics:</strong> ${selectedTopics.size} selected</p>`;
                } else {
                    result += `<p><strong>selectedTopics:</strong> Not available in current scope</p>`;
                }

                resultDiv.innerHTML = result;

            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #f8d7da; padding: 10px;">‚ùå Error: ${error.message}</div>`;
            }
        }

        function updateQuickSolutions() {
            const solutionsDiv = document.getElementById('quickSolutions');
            let solutions = '';

            if (diagnosticResults.currentUser === 'planets-test-user-2025') {
                solutions += `<div style="background: #f8d7da; padding: 15px; border-radius: 5px;">`;
                solutions += `<h4>üö® PRIMARY ISSUE: Test User with Incomplete Data</h4>`;
                solutions += `<p><strong>Problem:</strong> You're using a test user that only has 1 set (0 D-numbers).</p>`;
                solutions += `<p><strong>Solution:</strong> Switch to a different user with complete data.</p>`;
                solutions += `<p><strong>Good users:</strong> 8db9861a-76ce-4ae3-81b0-7a8b82314ef2, e57d8c46-0186-4749-b18d-9e170aaa5fce</p>`;
                solutions += `</div>`;
            } else if (diagnosticResults.hasExcelData === false) {
                solutions += `<div style="background: #fff3cd; padding: 15px; border-radius: 5px;">`;
                solutions += `<h4>üìä Missing Excel Data</h4>`;
                solutions += `<p>Upload Excel file for date 2025-06-26</p>`;
                solutions += `</div>`;
            } else if (diagnosticResults.dNumbersCount === 7) {
                solutions += `<div style="background: #f8d7da; padding: 15px; border-radius: 5px;">`;
                solutions += `<h4>üìä Incomplete Excel Data</h4>`;
                solutions += `<p>Your Excel file only has 7 D-numbers. Re-upload with all 15 D-numbers.</p>`;
                solutions += `</div>`;
            } else if (diagnosticResults.dNumbersCount === 15) {
                solutions += `<div style="background: #d1ecf1; padding: 15px; border-radius: 5px;">`;
                solutions += `<h4>üîç Frontend Processing Issue</h4>`;
                solutions += `<p>Excel data is complete. Issue is in topic filtering or component logic.</p>`;
                solutions += `<p>Check TOPIC_ORDER arrays and data transformation logic.</p>`;
                solutions += `</div>`;
            }

            if (solutions === '') {
                solutions = '<p>Complete all diagnostics above to get specific solutions...</p>';
            }

            solutionsDiv.innerHTML = solutions;
        }

        function showFixOptions() {
            const fixDiv = document.getElementById('fixOptions');
            
            let fixes = `<h4>üîß Available Fixes</h4>`;
            
            if (diagnosticResults.currentUser === 'planets-test-user-2025') {
                fixes += `<div style="background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
                fixes += `<h5>Option 1: Switch Users</h5>`;
                fixes += `<p>Select a different user in the application with complete data.</p>`;
                fixes += `<button onclick="window.alert('Go to user selection and choose: 8db9861a-76ce-4ae3-81b0-7a8b82314ef2')">üìù Show User Instructions</button>`;
                fixes += `</div>`;
                
                fixes += `<div style="background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
                fixes += `<h5>Option 2: Upload Complete Excel for Test User</h5>`;
                fixes += `<p>Upload a complete Excel file with 30 topics for the test user.</p>`;
                fixes += `<button onclick="window.alert('Upload Excel file with all 15 D-numbers (D-1,3,4,5,7,9,10,11,12,27,30,60,81,108,144)')">üìä Upload Instructions</button>`;
                fixes += `</div>`;
            } else {
                fixes += `<div style="background: #e9ecef; padding: 15px; border-radius: 5px; margin: 10px 0;">`;
                fixes += `<h5>General Troubleshooting</h5>`;
                fixes += `<p>1. Refresh the page</p>`;
                fixes += `<p>2. Clear browser cache</p>`;
                fixes += `<p>3. Re-upload Excel data if needed</p>`;
                fixes += `</div>`;
            }

            fixDiv.innerHTML = fixes;
        }

        // Auto-run the first check when page loads
        window.addEventListener('load', function() {
            setTimeout(checkCurrentUser, 1000);
        });
    </script>
</body>
</html>
