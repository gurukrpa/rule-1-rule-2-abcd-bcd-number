<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Verify Topic-Specific Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .topic-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .topic-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .topic-title { font-weight: bold; color: #007bff; margin-bottom: 8px; }
        .numbers { font-family: monospace; }
        button { padding: 12px 24px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; margin: 10px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Verify Topic-Specific ABCD/BCD Numbers Fix</h1>
        
        <div class="info">
            <h3>üéØ Test Status</h3>
            <p><strong>Database:</strong> Enhanced table created with topic-specific data ‚úÖ</p>
            <p><strong>Code:</strong> PlanetsAnalysisPage updated to load topic-specific numbers ‚úÖ</p>
            <p><strong>Testing:</strong> Verifying that the fix works end-to-end...</p>
        </div>

        <button onclick="testTopicSpecificLoading()">üß™ Test Topic-Specific Loading</button>
        <button onclick="simulatePlanetsPage()">üìä Simulate Planets Analysis Page</button>
        <button onclick="showExpectedResults()">üëÅÔ∏è Show Expected Results</button>

        <div id="results"></div>
        <div id="topicDisplay"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://wgnqlgwfpwdrkutktpvu.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnbnFsZ3dmcHdkcmt1dGt0cHZ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMzMjcwNTMsImV4cCI6MjA0ODkwMzA1M30.pTpyAJrH_RUumKPKmYyQ2iMhxaLg9FgFo5c4QHRYm7Y';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="${className}"><strong>[${timestamp}]</strong> ${message}</div>`;
        }

        async function testTopicSpecificLoading() {
            document.getElementById('results').innerHTML = '';
            log('üß™ Testing topic-specific data loading...', 'info');
            
            try {
                const { data, error } = await supabase
                    .from('rule2_analysis_results')
                    .select('*')
                    .eq('user_id', 'sing maya')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Error loading data: ${error.message}`, 'error');
                    return;
                }

                if (!data || data.length === 0) {
                    log('‚ùå No enhanced analysis data found', 'error');
                    return;
                }

                const result = data[0];
                const topicNumbers = result.topic_numbers || {};
                const topicCount = Object.keys(topicNumbers).length;

                log(`‚úÖ Enhanced data loaded successfully!`, 'success');
                log(`üìä Analysis Date: ${result.analysis_date}`, 'info');
                log(`üéØ Total Topics with specific numbers: ${topicCount}/30`, 'success');
                log(`üî¢ Overall ABCD: [${result.overall_abcd_numbers?.join(',') || 'none'}]`, 'info');
                
                if (topicCount > 0) {
                    log(`üéâ SUCCESS: Topic-specific numbers are available!`, 'success');
                    displayTopicNumbers(topicNumbers);
                } else {
                    log(`‚ùå No topic-specific numbers found`, 'error');
                }

            } catch (err) {
                log(`üí• Exception: ${err.message}`, 'error');
            }
        }

        async function simulatePlanetsPage() {
            document.getElementById('results').innerHTML = '';
            log('üìä Simulating PlanetsAnalysisPage logic...', 'info');
            
            // This simulates the exact logic from PlanetsAnalysisPage.jsx
            const userId = 'sing maya';
            
            try {
                // Primary: Enhanced rule2_analysis_results table
                log('üîç Step 1: Checking rule2_analysis_results table (primary source)...', 'info');
                const { data: enhancedData, error: enhancedError } = await supabase
                    .from('rule2_analysis_results')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (!enhancedError && enhancedData && enhancedData.length > 0) {
                    const result = enhancedData[0];
                    const topicNumbers = result.topic_numbers || {};
                    const topicCount = Object.keys(topicNumbers).length;
                    
                    log(`‚úÖ Enhanced analysis results found!`, 'success');
                    log(`üìÖ Source: rule2_analysis_results table`, 'success');
                    log(`üìä Analysis Date: ${result.analysis_date}`, 'info');
                    log(`üéØ HR Period: ${result.selected_hr}`, 'info');
                    log(`üìã Total Topics: ${result.total_topics}`, 'info');
                    log(`üéØ Topics with specific numbers: ${topicCount}`, 'success');
                    
                    if (topicCount > 0) {
                        log(`üéâ RESULT: PlanetsAnalysisPage will show TOPIC-SPECIFIC numbers!`, 'success');
                        log(`üö´ No more generic [1,2,3,4,5,6,7,8,9,10,11,12] for all topics`, 'success');
                        
                        // Show sample topic numbers
                        const sampleTopics = Object.entries(topicNumbers).slice(0, 5);
                        log(`üìã Sample topic-specific numbers:`, 'info');
                        sampleTopics.forEach(([topic, numbers]) => {
                            log(`  "${topic}": ABCD=[${numbers.abcd?.join(',') || 'none'}], BCD=[${numbers.bcd?.join(',') || 'none'}]`, 'success');
                        });
                        
                        displayTopicNumbers(topicNumbers);
                        return;
                    }
                }
                
                log('‚ö†Ô∏è Fallback: Would use rule2_results table (generic numbers)', 'error');
                
            } catch (err) {
                log(`üí• Exception: ${err.message}`, 'error');
            }
        }

        function displayTopicNumbers(topicNumbers) {
            const display = document.getElementById('topicDisplay');
            const topics = Object.entries(topicNumbers);
            
            let html = `
                <h3>üéØ Topic-Specific ABCD/BCD Numbers (${topics.length} topics)</h3>
                <div class="topic-grid">
            `;
            
            topics.forEach(([topicName, numbers]) => {
                html += `
                    <div class="topic-card">
                        <div class="topic-title">${topicName}</div>
                        <div class="numbers">
                            <strong>ABCD:</strong> [${numbers.abcd?.join(', ') || 'none'}]<br>
                            <strong>BCD:</strong> [${numbers.bcd?.join(', ') || 'none'}]
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            display.innerHTML = html;
        }

        function showExpectedResults() {
            const display = document.getElementById('topicDisplay');
            display.innerHTML = `
                <h3>‚úÖ Expected Results vs Previous Behavior</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <h4 style="color: #dc3545;">‚ùå Before Fix (Wrong)</h4>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px;">
                            <strong>All topics showed:</strong><br>
                            ABCD: [1,2,3,4,5,6,7,8,9,10,11,12]<br>
                            BCD: [None]<br><br>
                            <em>Same generic numbers for all 30 topics</em>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #28a745;">‚úÖ After Fix (Correct)</h4>
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px;">
                            <strong>D-1 Set-1 Matrix:</strong> ABCD=[1,2,4,7,9], BCD=[5]<br>
                            <strong>D-3 Set-1 Matrix:</strong> ABCD=[2,3,5,12], BCD=[1]<br>
                            <strong>D-4 Set-1 Matrix:</strong> ABCD=[1,5,9,12], BCD=[3,7]<br><br>
                            <em>Each topic has unique ABCD/BCD numbers</em>
                        </div>
                    </div>
                </div>
                <div class="success">
                    <h4>üéâ Fix Verification</h4>
                    <p>‚úÖ Enhanced database table created<br>
                    ‚úÖ Topic-specific data inserted<br>
                    ‚úÖ PlanetsAnalysisPage updated to load enhanced data<br>
                    ‚úÖ Intelligent fallback logic maintains compatibility</p>
                </div>
            `;
        }

        // Auto-test on page load
        window.onload = () => {
            setTimeout(() => {
                testTopicSpecificLoading();
            }, 1000);
        };
    </script>
</body>
</html>
