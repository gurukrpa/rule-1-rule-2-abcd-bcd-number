<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Critical Issues Resolution Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; font-family: monospace; }
        .logs { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; }
        h1 { color: #333; text-align: center; }
        h2 { color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-pending { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Critical Issues Resolution Test</h1>
        <p><strong>Testing the two critical errors that were reported:</strong></p>
        <ol>
            <li><strong>Database Connection Error</strong>: "real ABCD/BCD Data Not Available - Database connection issue"</li>
            <li><strong>Excel Upload Issue</strong>: Some topics are not fetching data from Excel upload</li>
        </ol>

        <!-- Test Results Summary -->
        <div id="summary" class="test-section info">
            <h2>üìä Test Results Summary</h2>
            <div id="summary-content">
                <p>üîÑ Starting tests...</p>
            </div>
        </div>

        <!-- Issue 1: Database Connection Test -->
        <div class="test-section">
            <h2>üõ†Ô∏è Issue #1: Database Connection Test</h2>
            <p><strong>Testing:</strong> Rule2AnalysisResultsService import and database connectivity</p>
            
            <button class="btn-primary" onclick="testDatabaseConnection()">Test Database Connection</button>
            <button class="btn-success" onclick="testRule2AnalysisService()">Test Rule2AnalysisResultsService</button>
            <button class="btn-warning" onclick="testEnhancedTableAccess()">Test Enhanced Table</button>
            
            <div id="db-results"></div>
        </div>

        <!-- Issue 2: Excel Upload Data Retrieval Test -->
        <div class="test-section">
            <h2>üìä Issue #2: Excel Upload Data Retrieval Test</h2>
            <p><strong>Testing:</strong> Topic data fetching and hasTopicData logic</p>
            
            <button class="btn-primary" onclick="testTopicDataStructure()">Test Topic Data Structure</button>
            <button class="btn-success" onclick="testHasTopicDataLogic()">Test hasTopicData Logic</button>
            <button class="btn-warning" onclick="testElementMapping()">Test Element Mapping</button>
            
            <div id="excel-results"></div>
        </div>

        <!-- Application Integration Test -->
        <div class="test-section">
            <h2>üåê Application Integration Test</h2>
            <p><strong>Testing:</strong> End-to-end functionality</p>
            
            <button class="btn-primary" onclick="testApplicationPages()">Test Application Pages</button>
            <button class="btn-success" onclick="testRealDataFlow()">Test Real Data Flow</button>
            
            <div id="integration-results"></div>
        </div>

        <!-- Live Logs -->
        <div class="test-section">
            <h2>üìù Live Test Logs</h2>
            <button class="btn-danger" onclick="clearLogs()">Clear Logs</button>
            <div id="logs" class="logs"></div>
        </div>
    </div>

    <script>
        // Supabase client setup
        const supabaseUrl = 'https://zndkprjytuhzufdqhnmt.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpuZGtwcmp5dHVoenVmZHFobm10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0OTg5OTgsImV4cCI6MjA1OTA3NDk5OH0._1xM__KPGNlr3HG3-An2fy3kKfIxWU-AXJnrMpdWYok';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let testResults = {
            databaseConnection: null,
            rule2Service: null,
            enhancedTable: null,
            topicDataStructure: null,
            hasTopicDataLogic: null,
            elementMapping: null,
            applicationPages: null,
            realDataFlow: null
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.className = `test-result ${type}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function updateSummary() {
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = Object.values(testResults).filter(r => r === false).length;
            const pending = Object.values(testResults).filter(r => r === null).length;
            const total = Object.keys(testResults).length;

            const summaryDiv = document.getElementById('summary-content');
            summaryDiv.innerHTML = `
                <div style="display: flex; gap: 20px; align-items: center;">
                    <div><span class="status-indicator status-success"></span><strong>Passed:</strong> ${passed}/${total}</div>
                    <div><span class="status-indicator status-error"></span><strong>Failed:</strong> ${failed}/${total}</div>
                    <div><span class="status-indicator status-pending"></span><strong>Pending:</strong> ${pending}/${total}</div>
                </div>
                <div style="margin-top: 10px;">
                    <strong>Progress:</strong> ${Math.round((passed + failed) / total * 100)}% complete
                </div>
            `;

            // Update summary section class
            const summarySection = document.getElementById('summary');
            if (failed > 0) {
                summarySection.className = 'test-section error';
            } else if (pending === 0) {
                summarySection.className = 'test-section success';
            } else {
                summarySection.className = 'test-section info';
            }
        }

        async function testDatabaseConnection() {
            log('üîç Testing basic Supabase database connection...', 'info');
            try {
                const { data, error } = await supabase
                    .from('rule2_results')
                    .select('count')
                    .limit(1);
                
                if (error) {
                    log(`‚ùå Database connection failed: ${error.message}`, 'error');
                    testResults.databaseConnection = false;
                } else {
                    log('‚úÖ Database connection successful!', 'success');
                    testResults.databaseConnection = true;
                }
            } catch (err) {
                log(`‚ùå Connection error: ${err.message}`, 'error');
                testResults.databaseConnection = false;
            }
            updateResults('db-results', 'databaseConnection');
            updateSummary();
        }

        async function testRule2AnalysisService() {
            log('üîç Testing Rule2AnalysisResultsService functionality...', 'info');
            try {
                // Test enhanced table which Rule2AnalysisResultsService uses
                const { data, error } = await supabase
                    .from('rule2_analysis_results')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('does not exist')) {
                        log('‚ö†Ô∏è Enhanced table does not exist - this would cause service import issues', 'warning');
                        testResults.rule2Service = false;
                    } else {
                        log(`‚ùå Rule2AnalysisResultsService test failed: ${error.message}`, 'error');
                        testResults.rule2Service = false;
                    }
                } else {
                    log('‚úÖ Rule2AnalysisResultsService can access enhanced table successfully!', 'success');
                    testResults.rule2Service = true;
                }
            } catch (err) {
                log(`‚ùå Service test error: ${err.message}`, 'error');
                testResults.rule2Service = false;
            }
            updateResults('db-results', 'rule2Service');
            updateSummary();
        }

        async function testEnhancedTableAccess() {
            log('üîç Testing enhanced rule2_analysis_results table access...', 'info');
            try {
                const { data, error } = await supabase
                    .from('rule2_analysis_results')
                    .select('user_id, analysis_date, topic_numbers')
                    .limit(3);
                
                if (error) {
                    log(`‚ùå Enhanced table access failed: ${error.message}`, 'error');
                    testResults.enhancedTable = false;
                } else {
                    log(`‚úÖ Enhanced table accessible! Found ${data.length} records`, 'success');
                    if (data.length > 0) {
                        log(`üìã Sample record structure: ${JSON.stringify(Object.keys(data[0]))}`, 'info');
                    }
                    testResults.enhancedTable = true;
                }
            } catch (err) {
                log(`‚ùå Enhanced table test error: ${err.message}`, 'error');
                testResults.enhancedTable = false;
            }
            updateResults('db-results', 'enhancedTable');
            updateSummary();
        }

        function testTopicDataStructure() {
            log('üîç Testing topic data structure for Excel upload...', 'info');
            
            // Mock the structure that would be created by processExcelData
            const mockTopicData = {
                'D-1 Set-1 Matrix': {
                    'as': {  // Lagna/Ascendant
                        'me': { value: 'me', rawData: 'me', hasData: true },
                        've': { value: 've', rawData: 've', hasData: true },
                        'ju': { value: 'ju', rawData: 'ju', hasData: true }
                    },
                    'mo': {  // Moon
                        'me': { value: 'me', rawData: 'me', hasData: true },
                        've': { value: 've', rawData: 've', hasData: true }
                    }
                },
                'D-3 Set-1 Matrix': {
                    'as': {
                        'ma': { value: 'ma', rawData: 'ma', hasData: true }
                    },
                    'mo': {}  // Empty - this could cause issues
                }
            };

            let passed = true;
            const issues = [];

            // Test each topic
            Object.keys(mockTopicData).forEach(topicName => {
                const topicData = mockTopicData[topicName];
                log(`üìä Testing topic: "${topicName}"`, 'info');
                
                // Test structure validation
                const hasElements = Object.keys(topicData).length > 0;
                const hasValidData = Object.values(topicData).some(elementData => 
                    Object.values(elementData).some(planetData => planetData.hasData === true)
                );
                
                if (!hasElements) {
                    issues.push(`${topicName}: No elements found`);
                    passed = false;
                } else if (!hasValidData) {
                    issues.push(`${topicName}: No valid planet data found`);
                    passed = false;
                } else {
                    log(`‚úÖ ${topicName}: Structure valid`, 'success');
                }
            });

            if (passed) {
                log('‚úÖ Topic data structure test passed!', 'success');
                testResults.topicDataStructure = true;
            } else {
                log(`‚ùå Topic data structure issues: ${issues.join(', ')}`, 'error');
                testResults.topicDataStructure = false;
            }
            
            updateResults('excel-results', 'topicDataStructure');
            updateSummary();
        }

        function testHasTopicDataLogic() {
            log('üîç Testing hasTopicData logic (the core of Excel upload issue)...', 'info');
            
            // Mock planets data with different scenarios
            const testScenarios = [
                {
                    name: 'Valid Topic with Data',
                    data: {
                        'as': { 'me': { hasData: true }, 've': { hasData: true } },
                        'mo': { 'ju': { hasData: true } }
                    },
                    expected: true
                },
                {
                    name: 'Topic with Empty Elements',
                    data: {
                        'as': { 'me': { hasData: false }, 've': { hasData: false } },
                        'mo': {}
                    },
                    expected: false
                },
                {
                    name: 'Topic with Mixed Data',
                    data: {
                        'as': { 'me': { hasData: true } },
                        'mo': { 've': { hasData: false } }
                    },
                    expected: true
                },
                {
                    name: 'Completely Empty Topic',
                    data: {},
                    expected: false
                }
            ];

            let allPassed = true;

            testScenarios.forEach(scenario => {
                // Test the actual hasTopicData logic from PlanetsAnalysisPage
                const hasTopicData = scenario.data && 
                    Object.values(scenario.data).some(elementData => 
                        elementData && Object.values(elementData).some(planetData => planetData.hasData === true)
                    );

                const passed = hasTopicData === scenario.expected;
                if (passed) {
                    log(`‚úÖ ${scenario.name}: PASS (expected: ${scenario.expected}, got: ${hasTopicData})`, 'success');
                } else {
                    log(`‚ùå ${scenario.name}: FAIL (expected: ${scenario.expected}, got: ${hasTopicData})`, 'error');
                    allPassed = false;
                }
            });

            testResults.hasTopicDataLogic = allPassed;
            updateResults('excel-results', 'hasTopicDataLogic');
            updateSummary();
        }

        function testElementMapping() {
            log('üîç Testing element name mapping (Excel ‚Üí Internal codes)...', 'info');
            
            const mappingTests = [
                { excel: 'lagna', expected: 'as', description: 'Lagna ‚Üí Ascendant' },
                { excel: 'ascendant', expected: 'as', description: 'Ascendant ‚Üí AS' },
                { excel: 'moon', expected: 'mo', description: 'Moon ‚Üí MO' },
                { excel: 'hora lagna', expected: 'hl', description: 'Hora Lagna ‚Üí HL' },
                { excel: 'ghati lagna', expected: 'gl', description: 'Ghati Lagna ‚Üí GL' }
            ];

            // Element name mapping from PlanetsAnalysisPage
            const elementNameMapping = {
                'as': 'as', 'mo': 'mo', 'hl': 'hl', 'gl': 'gl', 'vig': 'vig',
                'var': 'var', 'sl': 'sl', 'pp': 'pp', 'in': 'in',
                'lagna': 'as', 'ascendant': 'as', 'moon': 'mo',
                'hora lagna': 'hl', 'ghati lagna': 'gl', 'vighati lagna': 'vig',
                'varnada lagna': 'var', 'sree lagna': 'sl', 'pranapada lagna': 'pp',
                'indu lagna': 'in'
            };

            let allMapped = true;
            mappingTests.forEach(test => {
                const mapped = elementNameMapping[test.excel.toLowerCase()];
                if (mapped === test.expected) {
                    log(`‚úÖ ${test.description}: "${test.excel}" ‚Üí "${mapped}"`, 'success');
                } else {
                    log(`‚ùå ${test.description}: "${test.excel}" ‚Üí "${mapped || 'NOT MAPPED'}" (expected: "${test.expected}")`, 'error');
                    allMapped = false;
                }
            });

            testResults.elementMapping = allMapped;
            updateResults('excel-results', 'elementMapping');
            updateSummary();
        }

        function testApplicationPages() {
            log('üîç Testing application page accessibility...', 'info');
            
            const testUrls = [
                'http://localhost:5173/',
                'http://localhost:5173/planets-analysis',
                'http://localhost:5173/planets-analysis/test-user'
            ];

            Promise.all(testUrls.map(url => 
                fetch(url).then(response => ({ url, status: response.status, ok: response.ok }))
                .catch(error => ({ url, status: 'ERROR', ok: false, error: error.message }))
            )).then(results => {
                let allAccessible = true;
                results.forEach(result => {
                    if (result.ok) {
                        log(`‚úÖ ${result.url}: Accessible (${result.status})`, 'success');
                    } else {
                        log(`‚ùå ${result.url}: Not accessible (${result.status}${result.error ? ': ' + result.error : ''})`, 'error');
                        allAccessible = false;
                    }
                });
                
                testResults.applicationPages = allAccessible;
                updateResults('integration-results', 'applicationPages');
                updateSummary();
            });
        }

        function testRealDataFlow() {
            log('üîç Testing real data flow simulation...', 'info');
            
            // Simulate the data flow from database ‚Üí component ‚Üí display
            async function simulateDataFlow() {
                try {
                    // Step 1: Try to get analysis data
                    log('üìä Step 1: Testing analysis data retrieval...', 'info');
                    const analysisData = await supabase
                        .from('rule2_analysis_results')
                        .select('*')
                        .limit(1);
                    
                    // Step 2: Fallback to database
                    log('üóÑÔ∏è Step 2: Testing database fallback...', 'info');
                    const dbData = await supabase
                        .from('topic_abcd_bcd_numbers')
                        .select('*')
                        .limit(1);
                    
                    // Step 3: Test fallback data
                    log('üìã Step 3: Testing static fallback...', 'info');
                    const staticFallback = {
                        'D-1 Set-1 Matrix': { abcd: [10, 12], bcd: [4, 11] },
                        'D-3 Set-1 Matrix': { abcd: [1, 2, 8, 11], bcd: [4, 6] }
                    };
                    
                    const hasAnalysisData = !analysisData.error && analysisData.data.length > 0;
                    const hasDatabaseData = !dbData.error && dbData.data.length > 0;
                    const hasStaticFallback = Object.keys(staticFallback).length > 0;
                    
                    if (hasAnalysisData) {
                        log('‚úÖ Data flow: Analysis data available (best case)', 'success');
                    } else if (hasDatabaseData) {
                        log('‚úÖ Data flow: Database fallback available (good case)', 'success');
                    } else if (hasStaticFallback) {
                        log('‚ö†Ô∏è Data flow: Only static fallback available (acceptable)', 'warning');
                    } else {
                        log('‚ùå Data flow: No data source available (critical issue)', 'error');
                        testResults.realDataFlow = false;
                        updateResults('integration-results', 'realDataFlow');
                        updateSummary();
                        return;
                    }
                    
                    testResults.realDataFlow = true;
                    updateResults('integration-results', 'realDataFlow');
                    updateSummary();
                    
                } catch (error) {
                    log(`‚ùå Data flow test error: ${error.message}`, 'error');
                    testResults.realDataFlow = false;
                    updateResults('integration-results', 'realDataFlow');
                    updateSummary();
                }
            }
            
            simulateDataFlow();
        }

        function updateResults(containerId, testKey) {
            const container = document.getElementById(containerId);
            const result = testResults[testKey];
            
            let resultHtml = '';
            if (result === true) {
                resultHtml = `<div class="test-result success">‚úÖ ${testKey}: PASSED</div>`;
            } else if (result === false) {
                resultHtml = `<div class="test-result error">‚ùå ${testKey}: FAILED</div>`;
            } else {
                resultHtml = `<div class="test-result warning">‚è≥ ${testKey}: PENDING</div>`;
            }
            
            container.innerHTML = resultHtml;
        }

        // Auto-run critical tests on page load
        window.onload = function() {
            log('üöÄ Starting automatic critical issue resolution tests...', 'info');
            updateSummary();
            
            // Run database tests first
            setTimeout(() => testDatabaseConnection(), 500);
            setTimeout(() => testRule2AnalysisService(), 1000);
            setTimeout(() => testEnhancedTableAccess(), 1500);
            
            // Run Excel upload tests
            setTimeout(() => testTopicDataStructure(), 2000);
            setTimeout(() => testHasTopicDataLogic(), 2500);
            setTimeout(() => testElementMapping(), 3000);
            
            // Run integration tests
            setTimeout(() => testApplicationPages(), 3500);
            setTimeout(() => testRealDataFlow(), 4000);
        };
    </script>
</body>
</html>
