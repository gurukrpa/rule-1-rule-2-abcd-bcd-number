<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug ABCD/BCD Calculation Failure</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
    <h1>üîß Debug ABCD/BCD Calculation Failure</h1>
    
    <div class="error status">
        <strong>‚ùå Current Issue:</strong> Dynamic calculation failed for HR 1. The system cannot find required Excel data and Hour Entry data for all ABCD dates.
    </div>

    <div class="section">
        <h2>üìÖ ABCD Date Sequence Check</h2>
        <div id="abcdDates"></div>
        <button class="btn-primary" onclick="checkABCDDates()">Check Required Dates</button>
    </div>

    <div class="grid">
        <div class="section">
            <h2>üìä Excel Data Status</h2>
            <div id="excelStatus"></div>
            <button class="btn-primary" onclick="checkExcelData()">Check Excel Data</button>
        </div>

        <div class="section">
            <h2>‚è∞ Hour Entry Status</h2>
            <div id="hourEntryStatus"></div>
            <button class="btn-primary" onclick="checkHourEntryData()">Check Hour Entries</button>
        </div>
    </div>

    <div class="section">
        <h2>üóÑÔ∏è Database Status</h2>
        <div id="databaseStatus"></div>
        <button class="btn-primary" onclick="checkDatabase()">Check Database Tables</button>
    </div>

    <div class="section">
        <h2>üõ†Ô∏è Quick Fixes</h2>
        <div class="warning status">
            <strong>Potential Solutions:</strong>
            <ul>
                <li><strong>Missing Excel Data:</strong> Upload Excel files for dates: 2025-06-26, 2025-06-30, 2025-07-03, 2025-07-07</li>
                <li><strong>Missing Hour Entries:</strong> Complete hour entries for all ABCD dates</li>
                <li><strong>Database Table Missing:</strong> Create the topic_abcd_bcd_numbers table</li>
                <li><strong>Wrong User Context:</strong> Ensure you're using the correct userId</li>
            </ul>
        </div>
        
        <button class="btn-success" onclick="generateTestData()">üîß Generate Test Data</button>
        <button class="btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
    </div>

    <div class="section">
        <h2>üìã Debug Information</h2>
        <pre id="debugInfo">Click "Run Full Diagnostic" to see detailed information...</pre>
        <button class="btn-primary" onclick="runFullDiagnostic()">üîç Run Full Diagnostic</button>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Supabase connection (replace with your actual credentials)
        const supabaseUrl = 'https://ehxszmgzjqrjpkpwvwfe.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoeHN6bWd6anFyanBrcHd2d2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2NDcyMjksImV4cCI6MjA1MTIyMzIyOX0.C6iOD7P3ALqgAIVHQO6mqkRG5DF2Q93Jl1zK__9hGl0';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // ABCD Date sequence
        const ABCD_DATES = {
            A: '2025-06-26',
            B: '2025-06-30', 
            C: '2025-07-03',
            D: '2025-07-07'
        };

        // Get current user ID (you might need to adjust this)
        const getCurrentUserId = () => {
            // Try to get from localStorage first
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const parsed = JSON.parse(userData);
                    return parsed.id || parsed.userId || 'user-1';
                } catch (e) {
                    console.warn('Failed to parse userData from localStorage');
                }
            }
            
            // Check URL params
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('userId');
            if (userIdFromUrl) return userIdFromUrl;
            
            // Default fallback
            return 'user-1';
        };

        const userId = getCurrentUserId();

        window.checkABCDDates = function() {
            const resultDiv = document.getElementById('abcdDates');
            resultDiv.innerHTML = \`
                <div class="info status">
                    <h4>üìÖ Required ABCD Date Sequence:</h4>
                    <ul>
                        <li><strong>A-day:</strong> \${ABCD_DATES.A}</li>
                        <li><strong>B-day:</strong> \${ABCD_DATES.B}</li>
                        <li><strong>C-day:</strong> \${ABCD_DATES.C}</li>
                        <li><strong>D-day:</strong> \${ABCD_DATES.D}</li>
                    </ul>
                    <p><strong>Current User ID:</strong> \${userId}</p>
                </div>
            \`;
        };

        window.checkExcelData = async function() {
            const resultDiv = document.getElementById('excelStatus');
            resultDiv.innerHTML = '<div class="info status">üîç Checking Excel data...</div>';

            try {
                const results = [];
                
                for (const [letter, date] of Object.entries(ABCD_DATES)) {
                    const { data, error } = await supabase
                        .from('excel_uploads')
                        .select('id, file_name, data')
                        .eq('user_id', userId)
                        .eq('date', date)
                        .single();

                    if (error) {
                        results.push(\`‚ùå \${letter}-day (\${date}): \${error.message}\`);
                    } else if (data) {
                        const hasTopics = data.data?.sets ? Object.keys(data.data.sets).length : 0;
                        results.push(\`‚úÖ \${letter}-day (\${date}): \${data.file_name} - \${hasTopics} topics\`);
                    } else {
                        results.push(\`‚ùå \${letter}-day (\${date}): No data found\`);
                    }
                }

                resultDiv.innerHTML = \`
                    <div class="status \${results.some(r => r.includes('‚ùå')) ? 'error' : 'success'}">
                        <h4>üìä Excel Data Status:</h4>
                        \${results.map(r => \`<div>\${r}</div>\`).join('')}
                    </div>
                \`;

            } catch (error) {
                resultDiv.innerHTML = \`<div class="error status">‚ùå Error: \${error.message}</div>\`;
            }
        };

        window.checkHourEntryData = async function() {
            const resultDiv = document.getElementById('hourEntryStatus');
            resultDiv.innerHTML = '<div class="info status">üîç Checking hour entries...</div>';

            try {
                const results = [];
                
                for (const [letter, date] of Object.entries(ABCD_DATES)) {
                    const { data, error } = await supabase
                        .from('hour_entries')
                        .select('id, planet_selections')
                        .eq('user_id', userId)
                        .eq('date', date)
                        .single();

                    if (error) {
                        results.push(\`‚ùå \${letter}-day (\${date}): \${error.message}\`);
                    } else if (data) {
                        const hrCount = data.planet_selections ? Object.keys(data.planet_selections).length : 0;
                        const hasHR1 = data.planet_selections?.['1'] ? '‚úÖ' : '‚ùå';
                        results.push(\`\${hasHR1} \${letter}-day (\${date}): \${hrCount} HR entries (HR1: \${hasHR1})\`);
                    } else {
                        results.push(\`‚ùå \${letter}-day (\${date}): No hour entry found\`);
                    }
                }

                resultDiv.innerHTML = \`
                    <div class="status \${results.some(r => r.includes('‚ùå')) ? 'error' : 'success'}">
                        <h4>‚è∞ Hour Entry Status:</h4>
                        \${results.map(r => \`<div>\${r}</div>\`).join('')}
                    </div>
                \`;

            } catch (error) {
                resultDiv.innerHTML = \`<div class="error status">‚ùå Error: \${error.message}</div>\`;
            }
        };

        window.checkDatabase = async function() {
            const resultDiv = document.getElementById('databaseStatus');
            resultDiv.innerHTML = '<div class="info status">üîç Checking database tables...</div>';

            try {
                // Check topic_abcd_bcd_numbers table
                const { data: topicData, error: topicError } = await supabase
                    .from('topic_abcd_bcd_numbers')
                    .select('count(*)', { count: 'exact' })
                    .limit(1);

                const topicStatus = topicError 
                    ? \`‚ùå topic_abcd_bcd_numbers: \${topicError.message}\`
                    : \`‚úÖ topic_abcd_bcd_numbers: Table exists\`;

                // Check excel_uploads table
                const { data: excelData, error: excelError } = await supabase
                    .from('excel_uploads')
                    .select('count(*)', { count: 'exact' })
                    .eq('user_id', userId)
                    .limit(1);

                const excelStatus = excelError
                    ? \`‚ùå excel_uploads: \${excelError.message}\`
                    : \`‚úÖ excel_uploads: \${excelData[0]?.count || 0} records for user\`;

                // Check hour_entries table
                const { data: hourData, error: hourError } = await supabase
                    .from('hour_entries')
                    .select('count(*)', { count: 'exact' })
                    .eq('user_id', userId)
                    .limit(1);

                const hourStatus = hourError
                    ? \`‚ùå hour_entries: \${hourError.message}\`
                    : \`‚úÖ hour_entries: \${hourData[0]?.count || 0} records for user\`;

                resultDiv.innerHTML = \`
                    <div class="status info">
                        <h4>üóÑÔ∏è Database Status:</h4>
                        <div>\${topicStatus}</div>
                        <div>\${excelStatus}</div>
                        <div>\${hourStatus}</div>
                    </div>
                \`;

            } catch (error) {
                resultDiv.innerHTML = \`<div class="error status">‚ùå Database Error: \${error.message}</div>\`;
            }
        };

        window.generateTestData = async function() {
            alert('üöß Test data generation feature will be implemented based on diagnostic results. Please run the full diagnostic first.');
        };

        window.clearAllData = async function() {
            if (confirm('‚ö†Ô∏è This will clear all Excel uploads and hour entries for the current user. Continue?')) {
                try {
                    await supabase.from('excel_uploads').delete().eq('user_id', userId);
                    await supabase.from('hour_entries').delete().eq('user_id', userId);
                    alert('‚úÖ Data cleared successfully');
                    location.reload();
                } catch (error) {
                    alert('‚ùå Error clearing data: ' + error.message);
                }
            }
        };

        window.runFullDiagnostic = async function() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.textContent = 'üîç Running comprehensive diagnostic...';

            try {
                const diagnostic = {
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    abcdDates: ABCD_DATES,
                    excelData: {},
                    hourEntries: {},
                    issues: [],
                    recommendations: []
                };

                // Check each ABCD date
                for (const [letter, date] of Object.entries(ABCD_DATES)) {
                    // Excel data
                    const { data: excelData, error: excelError } = await supabase
                        .from('excel_uploads')
                        .select('*')
                        .eq('user_id', userId)
                        .eq('date', date)
                        .single();

                    diagnostic.excelData[letter] = {
                        date,
                        found: !excelError,
                        error: excelError?.message,
                        topics: excelData?.data?.sets ? Object.keys(excelData.data.sets).length : 0,
                        fileName: excelData?.file_name
                    };

                    if (excelError) {
                        diagnostic.issues.push(\`Missing Excel data for \${letter}-day (\${date})\`);
                        diagnostic.recommendations.push(\`Upload Excel file for \${date}\`);
                    }

                    // Hour entries
                    const { data: hourData, error: hourError } = await supabase
                        .from('hour_entries')
                        .select('*')
                        .eq('user_id', userId)
                        .eq('date', date)
                        .single();

                    diagnostic.hourEntries[letter] = {
                        date,
                        found: !hourError,
                        error: hourError?.message,
                        hrEntries: hourData?.planet_selections ? Object.keys(hourData.planet_selections) : [],
                        hasHR1: hourData?.planet_selections?.['1'] ? true : false
                    };

                    if (hourError || !hourData?.planet_selections?.['1']) {
                        diagnostic.issues.push(\`Missing HR1 data for \${letter}-day (\${date})\`);
                        diagnostic.recommendations.push(\`Complete hour entry for \${date} with HR1 selection\`);
                    }
                }

                // Database table check
                const { data: tableCheck, error: tableError } = await supabase
                    .from('topic_abcd_bcd_numbers')
                    .select('count(*)', { count: 'exact' })
                    .limit(1);

                if (tableError) {
                    diagnostic.issues.push('topic_abcd_bcd_numbers table does not exist');
                    diagnostic.recommendations.push('Create database table using setup-abcd-database.html');
                }

                debugDiv.textContent = JSON.stringify(diagnostic, null, 2);

                // Show quick summary
                const summary = \`
üîç DIAGNOSTIC SUMMARY
==================
‚Ä¢ Excel Data: \${Object.values(diagnostic.excelData).filter(d => d.found).length}/4 dates available
‚Ä¢ Hour Entries: \${Object.values(diagnostic.hourEntries).filter(d => d.found && d.hasHR1).length}/4 dates with HR1
‚Ä¢ Issues Found: \${diagnostic.issues.length}
‚Ä¢ Database Table: \${tableError ? 'Missing' : 'Available'}

\${diagnostic.issues.length > 0 ? '‚ùå ISSUES TO FIX:\\n' + diagnostic.issues.map(i => '‚Ä¢ ' + i).join('\\n') : '‚úÖ All checks passed!'}
                \`.trim();

                alert(summary);

            } catch (error) {
                debugDiv.textContent = 'Error running diagnostic: ' + error.message;
            }
        };

        // Auto-run basic checks on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkABCDDates();
                checkExcelData();
                checkHourEntryData();
                checkDatabase();
            }, 1000);
        });
    </script>
</body>
</html>
