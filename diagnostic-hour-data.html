<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hour-Specific Data Diagnostic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .hour-comparison { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .hour-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
        .hour-header { font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        .topic-data { font-family: monospace; font-size: 0.9em; margin: 5px 0; }
        .different { background-color: #e8f5e8; }
        .same { background-color: #fff8e1; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; background: #007bff; color: white; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üî¨ Hour-Specific ABCD/BCD Data Diagnostic</h1>
    
    <div class="info status">
        <strong>Purpose:</strong> This page tests the new RealTimeRule2AnalysisService implementation to verify that each hour fetches its own unique real ABCD/BCD data.
    </div>
    
    <button onclick="runDiagnostic()">üöÄ Run Diagnostic Test</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    
    <div id="results"></div>

    <script type="module">
        let currentTest = null;
        
        window.runDiagnostic = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="info status">üîÑ Running diagnostic test...</div>';
            
            try {
                console.log('üî¨ Starting hour-specific data diagnostic...');
                
                // Test parameters
                const testParams = {
                    userId: 'planets-test-user-2025',
                    datesList: ['2024-12-28', '2024-12-29', '2024-12-30', '2024-12-31'],
                    latestDate: '2024-12-31'
                };
                
                resultsDiv.innerHTML += `
                    <div class="info status">
                        <h3>üìã Test Parameters</h3>
                        <pre>${JSON.stringify(testParams, null, 2)}</pre>
                    </div>
                `;
                
                // Step 1: Import the service
                console.log('üì¶ Importing RealTimeRule2AnalysisService...');
                const { RealTimeRule2AnalysisService } = await import('./src/services/realTimeRule2AnalysisService.js');
                
                resultsDiv.innerHTML += '<div class="success status">‚úÖ Successfully imported RealTimeRule2AnalysisService</div>';
                
                // Step 2: Test the analysis
                console.log('üîç Testing analysis...');
                const startTime = Date.now();
                
                const result = await RealTimeRule2AnalysisService.performRule2Analysis(
                    testParams.userId,
                    testParams.latestDate,
                    testParams.datesList
                );
                
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                if (result.success && result.data.hrResults) {
                    const hrResults = result.data.hrResults;
                    const availableHours = Object.keys(hrResults).sort((a, b) => parseInt(a) - parseInt(b));
                    
                    resultsDiv.innerHTML += `
                        <div class="success status">
                            <h3>‚úÖ Analysis Successful</h3>
                            <p><strong>Duration:</strong> ${duration}ms</p>
                            <p><strong>Available Hours:</strong> ${availableHours.join(', ')}</p>
                            <p><strong>Analysis Date:</strong> ${result.data.analysisDate}</p>
                        </div>
                    `;
                    
                    // Step 3: Compare hour data
                    console.log('üîç Comparing hour data...');
                    let comparisonHTML = '<h2>üìä Hour-by-Hour Data Comparison</h2>';
                    comparisonHTML += '<div class="hour-comparison">';
                    
                    const testTopics = ['D-1 Set-1 Matrix', 'D-3 Set-1 Matrix', 'D-1 Set-2 Matrix'];
                    let uniqueDataCount = 0;
                    
                    // Create comparison data
                    const comparisonData = {};
                    availableHours.forEach(hr => {
                        const hrData = hrResults[hr];
                        comparisonData[hr] = {
                            hasError: !!hrData.error,
                            error: hrData.error,
                            overallABCD: hrData.overallAbcdNumbers?.join(',') || '',
                            overallBCD: hrData.overallBcdNumbers?.join(',') || '',
                            topics: {}
                        };
                        
                        if (!hrData.error && hrData.topicResults) {
                            testTopics.forEach(topicName => {
                                const topicResult = hrData.topicResults.find(t => t.setName === topicName);
                                if (topicResult) {
                                    comparisonData[hr].topics[topicName] = {
                                        abcd: topicResult.abcdNumbers?.join(',') || '',
                                        bcd: topicResult.bcdNumbers?.join(',') || ''
                                    };
                                }
                            });
                        }
                    });
                    
                    // Generate hour cards
                    availableHours.forEach(hr => {
                        const hrData = comparisonData[hr];
                        const cardClass = hrData.hasError ? 'error' : 'success';
                        
                        comparisonHTML += `<div class="hour-card ${cardClass}">`;
                        comparisonHTML += `<div class="hour-header">üïê Hour ${hr}</div>`;
                        
                        if (hrData.hasError) {
                            comparisonHTML += `<div class="error">‚ùå Error: ${hrData.error}</div>`;
                        } else {
                            comparisonHTML += `
                                <div class="topic-data"><strong>Overall ABCD:</strong> [${hrData.overallABCD}]</div>
                                <div class="topic-data"><strong>Overall BCD:</strong> [${hrData.overallBCD}]</div>
                                <hr style="margin: 10px 0;">
                            `;
                            
                            testTopics.forEach(topicName => {
                                const topicData = hrData.topics[topicName];
                                if (topicData) {
                                    comparisonHTML += `
                                        <div class="topic-data">
                                            <strong>${topicName}:</strong><br>
                                            ABCD: [${topicData.abcd}]<br>
                                            BCD: [${topicData.bcd}]
                                        </div>
                                    `;
                                }
                            });
                        }
                        
                        comparisonHTML += '</div>';
                    });
                    
                    comparisonHTML += '</div>';
                    
                    // Step 4: Analyze differences
                    if (availableHours.length > 1) {
                        const firstHour = availableHours[0];
                        const firstHourData = comparisonData[firstHour];
                        
                        let differenceHTML = '<h2>üîç Difference Analysis</h2>';
                        differenceHTML += '<table border="1" style="width:100%; border-collapse: collapse;">';
                        differenceHTML += '<tr><th>Hour</th><th>Overall ABCD</th><th>Overall BCD</th><th>D-1 Set-1</th><th>Status</th></tr>';
                        
                        availableHours.forEach(hr => {
                            const hrData = comparisonData[hr];
                            const isDifferent = hr !== firstHour && (
                                hrData.overallABCD !== firstHourData.overallABCD ||
                                hrData.overallBCD !== firstHourData.overallBCD ||
                                (hrData.topics['D-1 Set-1 Matrix'] && firstHourData.topics['D-1 Set-1 Matrix'] && 
                                 (hrData.topics['D-1 Set-1 Matrix'].abcd !== firstHourData.topics['D-1 Set-1 Matrix'].abcd))
                            );
                            
                            if (isDifferent) uniqueDataCount++;
                            
                            const rowClass = isDifferent ? 'different' : 'same';
                            const statusText = hr === firstHour ? 'üìä Reference' : (isDifferent ? '‚úÖ Unique' : '‚ö†Ô∏è Same');
                            
                            differenceHTML += `<tr class="${rowClass}">`;
                            differenceHTML += `<td><strong>HR ${hr}</strong></td>`;
                            differenceHTML += `<td>[${hrData.overallABCD}]</td>`;
                            differenceHTML += `<td>[${hrData.overallBCD}]</td>`;
                            
                            const d1data = hrData.topics['D-1 Set-1 Matrix'];
                            differenceHTML += `<td>${d1data ? `A[${d1data.abcd}] B[${d1data.bcd}]` : 'No data'}</td>`;
                            differenceHTML += `<td>${statusText}</td>`;
                            differenceHTML += '</tr>';
                        });
                        
                        differenceHTML += '</table>';
                        comparisonHTML += differenceHTML;
                    }
                    
                    // Final result
                    const finalStatus = uniqueDataCount > 0 ? 'success' : 'warning';
                    const finalMessage = uniqueDataCount > 0 
                        ? `üéâ SUCCESS! ${uniqueDataCount} hours have unique ABCD/BCD data - Each hour is fetching its own real data!`
                        : '‚ö†Ô∏è All hours showing identical data - May be using fallback data instead of hour-specific real data';
                    
                    comparisonHTML += `
                        <div class="${finalStatus} status">
                            <h3>${finalMessage}</h3>
                            <p><strong>Implementation Status:</strong> ${uniqueDataCount > 0 ? 'Working correctly' : 'Needs investigation'}</p>
                        </div>
                    `;
                    
                    resultsDiv.innerHTML += comparisonHTML;
                    
                    console.log(`üéØ Diagnostic completed: ${uniqueDataCount} hours with unique data`);
                    
                } else {
                    resultsDiv.innerHTML += `
                        <div class="error status">
                            <h3>‚ùå Analysis Failed</h3>
                            <p><strong>Error:</strong> ${result.error || 'Unknown error'}</p>
                            <p>The RealTimeRule2AnalysisService could not perform the analysis.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Diagnostic failed:', error);
                resultsDiv.innerHTML += `
                    <div class="error status">
                        <h3>‚ùå Diagnostic Exception</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        // Auto-run on page load
        console.log('üöÄ Auto-running diagnostic on page load...');
        setTimeout(() => {
            window.runDiagnostic();
        }, 1000);
    </script>
</body>
</html>
